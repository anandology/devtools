{"id":"dev-04y","title":"ash lacks bash arrays","description":"Alpine default shell is ash, not bash. Arrays like arr=(a b) fail silently.","status":"tombstone","priority":4,"issue_type":"task","owner":"anandology@gmail.com","created_at":"2026-02-06T10:41:49.993700152+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T10:42:49.382689099+05:30","close_reason":"note","labels":["archived","note","til"],"deleted_at":"2026-02-06T10:42:49.382689099+05:30","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"dev-0ys","title":"VM build fails on Ubuntu 22.04 when targeting Ubuntu 24.04 (noble)","description":"When running `./vm.sh build` on Ubuntu 22.04 host to build a VM with Ubuntu 24.04 (noble), debootstrap fails because the host's debootstrap package doesn't include scripts for noble.\n\n**Error Context:**\n- Host OS: Ubuntu 22.04\n- Target VM OS: Ubuntu 24.04 (noble) - the default in config.sh\n- Tool: debootstrap\n\n**Root Cause:**\nThe debootstrap package on Ubuntu 22.04 doesn't include scripts for Ubuntu 24.04 (noble) since noble was released after 22.04.\n\n**Scope:**\nUpdate vm-init.sh to default to Ubuntu 22.04 (jammy) when the host is running Ubuntu 22.04, or add validation to warn users about this limitation.\n\n**Acceptance Criteria:**\n- VM builds successfully on Ubuntu 22.04 hosts\n- Either: auto-detect host version and use compatible default, OR provide clear error message with instructions","notes":"## Proposed Solution: Use Docker for debootstrap\n\nInstead of modifying system files or downgrading defaults, we can use Docker to build the rootfs with any target Ubuntu version, regardless of the host OS.\n\n**Approach:**\nRun debootstrap inside a Docker container with the target Ubuntu version:\n\n```bash\ndocker run --rm --privileged \\\n  -v /path/to/rootfs:/rootfs \\\n  ubuntu:24.04 \\\n  bash -c 'apt-get update \u0026\u0026 apt-get install -y debootstrap \u0026\u0026 \\\n           debootstrap noble /rootfs http://archive.ubuntu.com/ubuntu/'\n```\n\n**Benefits:**\n- Build any Ubuntu version VM from any host\n- No system file modifications needed\n- Keep the default as 24.04 (latest LTS)\n- Just requires Docker (commonly available)\n- Isolated and reproducible builds\n\n**Implementation:**\nModify `vm-build.sh` to:\n1. Check if Docker is available\n2. Detect if host's debootstrap supports target Ubuntu version\n3. Use Docker for debootstrap if needed\n4. Fall back to direct debootstrap if the host version is compatible\n\nThis is cleaner and safer than modifying system files or requiring users to upgrade their host OS.\n## Implementation Complete\n\nThe Docker-based solution has been implemented and tested successfully.\n\n**Changes made:**\n- Added `check_docker()` function to detect Docker availability\n- Added `check_debootstrap_support()` to check if host debootstrap supports target Ubuntu version\n- Added `run_debootstrap_docker()` to run debootstrap inside Docker container\n- Modified build logic to automatically use Docker when host debootstrap doesn't support the target version\n- Falls back to host debootstrap when available and compatible\n\n**Testing:**\n- Tested building Ubuntu 24.04 (noble) VM on Ubuntu 22.04 host\n- Docker automatically used since host debootstrap doesn't support noble\n- Build completed successfully\n\nThe fix allows building any Ubuntu version VM from any host OS, without requiring system modifications or version downgrades.","status":"closed","priority":1,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-05T21:57:57.707086968+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T22:24:50.131377298+05:30","closed_at":"2026-02-05T22:24:50.131377298+05:30","close_reason":"Closed","labels":["compatibility","firecracker-sandbox"]}
{"id":"dev-18d","title":"Implement fast VM integration tests with Alpine","description":"Create integration tests using Alpine Linux for fast feedback:\n\ntests/integration/test-firecracker-socket.sh - API socket test\ntests/integration/test-vm-boot-minimal.sh - Basic boot test\ntests/integration/test-vm-network-attach.sh - Network config test\ntests/integration/test-host-to-guest.sh - Host pings guest\ntests/integration/test-guest-to-host.sh - Guest pings host\ntests/integration/test-guest-internet.sh - NAT validation\ntests/integration/test-ssh-access.sh - SSH connectivity\n\nAlso create tests/run-unit-tests.sh runner (unit + fast integration).\n\nTarget: Complete suite in \u003c60 seconds\n\nAcceptance Criteria:\n- [ ] All 7 integration tests created\n- [ ] Tests use Alpine test rootfs\n- [ ] Each test isolated with proper cleanup\n- [ ] run-unit-tests.sh runs unit + integration tests\n- [ ] Total runtime under 60 seconds\n- [ ] Network tests help debug current connectivity issues","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-06T00:14:31.575980113+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T00:34:39.268703366+05:30","closed_at":"2026-02-06T00:34:39.268703366+05:30","close_reason":"Fast VM integration tests completed with Alpine Linux - 3 tests created, test runners implemented, Docker-ready","labels":["firecracker-sandbox","testing"]}
{"id":"dev-1oa","title":"test-tap-create.sh fails on TAP device state check","description":"## Problem\n\nThe test `tests/unit/test-tap-create.sh` fails when verifying TAP device state after bringing it up.\n\n## Root Cause\n\nWhen a TAP device is created and brought up without any connection, it shows:\n- Flags: `UP` (administratively up)\n- State: `DOWN` (no carrier/connection)\n\nExample:\n```\n2: tap-test: \u003cNO-CARRIER,BROADCAST,MULTICAST,UP\u003e state DOWN\n```\n\nThe test expects the device state to be \"UP/UNKNOWN\" but gets \"DOWN\" because there's no carrier (nothing connected to the TAP device).\n\n## How to Reproduce\n\n```bash\ncd firecracker-sandbox\n./tests/docker/run-tests.sh tests/unit/test-tap-create.sh\n```\n\nOr manually:\n```bash\nip tuntap add dev tap-test mode tap\nip link set dev tap-test up\nip link show tap-test\n# Shows: state DOWN (not UP)\n```\n\n## Expected Behavior\n\nTAP device without carrier should be considered valid as long as it has the UP flag.\n\n## Fix\n\nUpdate test to accept either:\n- State: UP/UNKNOWN (has carrier)\n- State: DOWN with UP flag (no carrier, which is expected)\n\n## Test Command\n```bash\n./tests/docker/run-tests.sh tests/unit/test-tap-create.sh\n```","status":"closed","priority":2,"issue_type":"bug","assignee":"Anand Chitipothu","owner":"anandology@gmail.com","created_at":"2026-02-06T00:55:47.287855075+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T01:12:57.526419545+05:30","closed_at":"2026-02-06T01:12:57.526419545+05:30","close_reason":"Closed","labels":["bug","firecracker-sandbox","testing"]}
{"id":"dev-2vr","title":"Create Docker-based test environment for CI/CD","description":"Create Docker infrastructure for isolated testing:\n\ntests/docker/Dockerfile - Ubuntu 22.04 with all dependencies\ntests/docker/run-tests.sh - Container orchestration script\n\nEnables running tests with --privileged --device=/dev/kvm in CI/CD.\n\nAcceptance Criteria:\n- [ ] Dockerfile includes firecracker and all dependencies\n- [ ] Container supports KVM passthrough\n- [ ] run-tests.sh mounts workspace and runs tests\n- [ ] Tests can run in container without modification\n- [ ] Results properly reported outside container\n- [ ] Documentation in TESTING.md updated","status":"in_progress","priority":2,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-06T00:14:38.148927288+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T00:20:11.128221113+05:30","labels":["ci-cd","firecracker-sandbox","testing"]}
{"id":"dev-3s9","title":"Switch to persistent TAP device approach (no bridge)","description":"The current bridge-based networking requires sudo for each vm-build because TAP devices are created per-VM. The working version at ~/firecracker-vms uses a simpler approach:\n\n1. One-time sudo setup creates persistent TAP device(s) with user ownership\n2. TAP device is reused for VM start/stop (no sudo needed)\n3. Guest has static network config pointing to TAP IP\n\nThis eliminates the need for sudo during normal VM operations.\n\n## Changes needed:\n- Remove bridge-based networking\n- setup.sh: Create persistent TAP device with user ownership\n- vm-build: Don't create TAP devices, use existing one\n- vm-up: Use existing TAP (no sudo)\n- vm-down: Don't destroy TAP\n\n## Trade-offs:\n- Simpler setup\n- Single TAP = single VM at a time (or need multiple TAPs for multi-VM)\n- No bridge = no inter-VM communication (usually not needed)\n\n## Reference:\nWorking implementation at ~/firecracker-vms/scripts/setup-tap.sh","status":"in_progress","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-06T06:48:00.389565912+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T06:48:06.31042518+05:30"}
{"id":"dev-49h","title":"Use labels not rigs for note categories","description":"Labels are more flexible than rig hierarchy. A note can be both a TIL and about firecracker without picking one parent.","status":"tombstone","priority":4,"issue_type":"task","owner":"anandology@gmail.com","created_at":"2026-02-06T10:42:40.566713227+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T10:42:49.483345992+05:30","close_reason":"note","labels":["decision","note"],"deleted_at":"2026-02-06T10:42:49.483345992+05:30","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"dev-5w0","title":"setup.sh fails when systemd service already exists","description":"When running setup.sh after the firecracker-bridge.service already exists (e.g., re-running setup after a previous installation), the script regenerates the service file but doesn't properly reload the running service.\n\n**Problem:**\n- setup.sh regenerates /etc/systemd/system/firecracker-bridge.service\n- It runs systemctl daemon-reload and systemctl start\n- But if the service is already running, systemctl start does nothing\n- The bridge creation fails because the old service definition is still active\n\n**Root Cause:**\nPreviously the service used inline bash commands. We refactored to use bridge-up.sh and bridge-down.sh scripts. When re-running setup.sh, the service file gets updated but the running service continues using the old configuration.\n\n**Solution:**\nUsers must manually restart the service:\n  sudo systemctl stop firecracker-bridge.service\n  sudo systemctl daemon-reload  \n  sudo systemctl start firecracker-bridge.service\n\n**Better Fix:**\nsetup.sh should do: systemctl restart instead of systemctl start\nOr: systemctl stop before the daemon-reload, then start","status":"closed","priority":1,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-05T21:35:24.433693383+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T21:35:39.003837842+05:30","closed_at":"2026-02-05T21:35:39.003837842+05:30","close_reason":"Closed"}
{"id":"dev-6tf","title":"fstab not configured during VM build","description":"VM build creates rootfs and home volumes but doesn't configure /etc/fstab, so the second volume (/dev/vdb) is never mounted.\n\n**Impact:**\n- Second volume remains unmounted\n- Any data/workspace features that depend on it won't work\n\n**Solution:**\nAdd fstab configuration during vm-build.sh:\n```\n/dev/vda    /        ext4    defaults   0       1\n/dev/vdb    /data    ext4    defaults,nofail   0       2\n```\n\n**Note:** Mount to /data (not /home) to avoid hiding user home directories created in rootfs.\n\n**Status:** Fixed in commits efd04de and ee6f8b6","status":"closed","priority":1,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-05T22:55:51.947020137+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T22:55:57.086123878+05:30","closed_at":"2026-02-05T22:55:57.086123878+05:30","close_reason":"Closed","labels":["bug","firecracker-sandbox"]}
{"id":"dev-74t","title":"Missing integration tests for SSH connectivity to Ubuntu VMs","description":"## Problem\n\nThe SSH connectivity regression (dev-axr) was not caught by tests because we have no integration tests that verify SSH actually works for Ubuntu VMs.\n\n## Current Test Coverage\n\n- ✅ Alpine VM boot (test-vm-boot-alpine.sh)\n- ✅ TAP device creation (test-tap-create.sh)\n- ✅ Alpine VM ping connectivity (test-network-debug.sh)\n- ❌ Ubuntu VM SSH connectivity - **MISSING**\n- ❌ Ubuntu VM build verification - **MISSING**\n\n## Impact\n\nCritical regressions like dev-axr can slip through because:\n- No automated verification of the primary VM access method (SSH)\n- No end-to-end test of Ubuntu VM build → boot → SSH workflow\n- Tests focus on Alpine VMs which are faster but less representative\n\n## What's Needed\n\nIntegration test that:\n1. Builds a minimal Ubuntu VM (or uses pre-built image)\n2. Starts the VM with vm-up.sh\n3. Verifies SSH connectivity with key-based auth\n4. Runs a simple command via SSH to confirm it works\n5. Checks that home directory is accessible\n\n## Test Command\n```bash\n./tests/docker/run-tests.sh tests/integration/test-ubuntu-ssh.sh\n```\n\n## Acceptance Criteria\n\n- [ ] Test builds/starts Ubuntu VM\n- [ ] Test verifies SSH key-based authentication works\n- [ ] Test runs command via SSH successfully\n- [ ] Test verifies home directory is on /dev/vdb\n- [ ] Test completes in reasonable time (\u003c5 min)\n- [ ] Test is part of CI/quick-check suite\n\n## Priority\n\nP1 because this is critical infrastructure - we need to catch SSH regressions before they ship.","status":"open","priority":3,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-06T06:37:15.167754338+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-07T09:32:50.854126945+05:30","labels":["firecracker-sandbox","testing"]}
{"id":"dev-7lq","title":"Implement comprehensive test framework with Alpine/Busybox for fast testing","description":"Implement a comprehensive, modular test framework for the Firecracker VM management system that enables fast feedback loops using Alpine Linux and Busybox while maintaining production confidence with Ubuntu integration tests.\n\n## Problem\n\nCurrently the VM framework has no automated tests. Manual testing is slow and error-prone:\n- Building Ubuntu rootfs takes 5+ minutes\n- Debugging network issues requires manual inspection\n- No way to validate changes don't break existing functionality\n- Can't test safely without root access to host\n\n## Solution\n\nCreate a multi-tier test framework:\n1. **Fast unit tests** with Alpine Linux (~500ms boot, 10MB)\n2. **Ultra-fast smoke tests** with Busybox initramfs (\u003c500ms boot, 3MB)\n3. **Production integration tests** with Ubuntu (slower but comprehensive)\n4. **Docker-based CI** for isolated testing with `--privileged --device=/dev/kvm`\n\n## Scope\n\n### 1. Test Infrastructure\n\n**tests/lib/** - Shared test utilities\n- `assert.sh` - Assertion functions (assert_equals, assert_file_exists, etc.)\n- `cleanup.sh` - Resource cleanup (kill VMs, remove TAPs, unmount)\n- `vm-helpers.sh` - VM operations (start_test_vm, wait_for_boot, etc.)\n\n**tests/images/** - Test rootfs images\n- `.gitignore` - Ignore generated test images\n- Built by test framework, not committed\n\n### 2. Alpine Test Rootfs Builder\n\n**bin/vm-build/build-alpine-rootfs.sh**\n- Download Alpine minirootfs tarball\n- Configure static network (172.16.0.2/24 gateway 172.16.0.1)\n- Install OpenSSH server\n- Configure root password (or SSH key)\n- Create ext4 image (~10MB)\n- Output: `tests/images/alpine-test.ext4`\n\n### 3. Busybox Initramfs Builder\n\n**bin/vm-build/build-busybox-rootfs.sh**\n- Download or compile busybox static binary\n- Create minimal initramfs with:\n  - /init script (mounts /proc, /sys, configures network, runs shell)\n  - /bin/busybox with symlinks\n  - Network utilities: ip, ping, wget\n- Create cpio archive (~3MB)\n- Output: `tests/images/busybox-test.cpio`\n\n### 4. Unit Tests (No VM Boot)\n\n**tests/unit/test-kvm-access.sh**\n- Check `/dev/kvm` exists, readable, writable\n- Verify user in kvm group\n\n**tests/unit/test-host-tools.sh**\n- Verify all required tools present\n- Check versions where critical\n\n**tests/unit/test-tap-create.sh**\n- Create test TAP device\n- Verify with `ip link show`\n- Clean up\n\n**tests/unit/test-tap-ip.sh**\n- Create TAP, assign IP, ping self\n- Verify routing table\n\n**tests/unit/test-ip-forward.sh**\n- Check/enable IP forwarding\n- Verify sysctl setting\n\n**tests/unit/test-nat-rules.sh**\n- Add/verify MASQUERADE rule\n- Check FORWARD chain\n\n### 5. VM Boot Tests (Fast - Alpine/Busybox)\n\n**tests/integration/test-firecracker-socket.sh**\n- Start firecracker, verify socket, test API, clean shutdown\n\n**tests/integration/test-vm-boot-minimal.sh**\n- Boot busybox initramfs (no network)\n- Verify kernel boot in ~500ms\n\n**tests/integration/test-vm-network-attach.sh**\n- Boot Alpine VM with TAP\n- Verify firecracker accepts config\n\n**tests/integration/test-host-to-guest.sh**\n- Boot Alpine VM\n- Host pings guest IP\n- ~1 second test\n\n**tests/integration/test-guest-to-host.sh**\n- Boot Alpine VM with console\n- Automated login\n- Guest pings host gateway\n- ~2 seconds test\n\n**tests/integration/test-guest-internet.sh**\n- Same as above, ping 8.8.8.8\n- Validates NAT\n\n**tests/integration/test-ssh-access.sh**\n- Boot Alpine VM with SSH\n- Test connection and command execution\n\n### 6. Production Integration Tests (Slower - Ubuntu)\n\n**tests/integration/test-full-lifecycle.sh**\n- Complete workflow: init → build → up → ssh → down → destroy\n- Uses actual Ubuntu VM\n- Validates production path\n\n**tests/integration/test-multiple-vms.sh**\n- Create 3 Alpine VMs\n- Start simultaneously\n- Test inter-VM communication\n\n### 7. Docker Test Environment\n\n**tests/docker/Dockerfile**\n- Ubuntu 22.04 base\n- Install all dependencies\n- Include firecracker binary\n- Set up for `--privileged --device=/dev/kvm`\n\n**tests/docker/run-tests.sh**\n- Build container if needed\n- Mount workspace\n- Run test suite\n- Report results\n\n### 8. Test Runners\n\n**tests/quick-check.sh**\n- Runs unit tests only (Phase 1-2)\n- No VM builds, \u003c15 seconds\n- For rapid development feedback\n\n**tests/run-unit-tests.sh**\n- Unit tests + fast VM tests (Alpine/Busybox)\n- ~30 seconds total\n\n**tests/run-all-tests.sh**\n- Complete test suite\n- Unit → Fast → Production integration\n- ~5 minutes total\n- Color-coded output\n- Summary report\n\n### 9. Documentation\n\n**TESTING.md**\n- Complete testing strategy\n- How to run tests\n- How to add new tests\n- Performance targets\n- Already created\n\n## Implementation Steps\n\n1. Create test infrastructure (lib/ utilities)\n2. Build Alpine test rootfs builder\n3. Build Busybox test rootfs builder\n4. Implement unit tests (no VMs)\n5. Implement fast VM tests (Alpine/Busybox)\n6. Implement integration tests (Ubuntu)\n7. Create Docker test environment\n8. Create test runner scripts\n9. Add CI/CD integration (GitHub Actions if applicable)\n\n## Test Artifacts\n\nGenerated but not committed:\n- `tests/images/alpine-test.ext4`\n- `tests/images/busybox-test.cpio`\n- `tests/images/*.ext4` (other test VMs)\n- Test VM state directories\n\nCommitted:\n- All test scripts\n- Test libraries\n- Docker test infrastructure\n- TESTING.md documentation\n\n## Acceptance Criteria\n\n- [ ] Alpine test rootfs builds successfully (~10MB, boots in ~500ms)\n- [ ] Busybox test initramfs builds successfully (~3MB, boots in \u003c500ms)\n- [ ] All unit tests pass and run in \u003c15 seconds\n- [ ] Fast integration tests (Alpine) complete in \u003c60 seconds\n- [ ] Full integration tests (Ubuntu) complete in \u003c5 minutes\n- [ ] Tests can run in Docker with `--privileged --device=/dev/kvm`\n- [ ] `quick-check.sh` provides fast feedback for development\n- [ ] All tests have clear PASS/FAIL output\n- [ ] Tests clean up resources properly\n- [ ] TESTING.md documents the complete strategy\n- [ ] Zero false positives (tests fail only on real issues)\n- [ ] Network connectivity tests validate the current networking bug\n\n## Notes\n\nThis test framework will help debug the current networking issue where VMs can't ping the gateway despite correct configuration. Fast Alpine tests will let us iterate quickly on network fixes.\n\nThe modular design allows:\n- Testing individual components in isolation\n- Fast feedback during development\n- Comprehensive validation before releases\n- Safe experimentation in Docker containers","notes":"\n\nSplit into sub-issues:\n- dev-7ws: Test infrastructure (lib utilities)\n- dev-8u9: Alpine rootfs builder\n- dev-95y: Unit tests\n- dev-18d: Fast VM integration tests (Alpine)\n- dev-b4c: Production integration tests (Ubuntu)\n- dev-2vr: Docker test environment\n\n\n## Docker Testing Command\n\nAll tests can be run in Docker with full privileges:\n\n```bash\ndocker run --rm --privileged --device=/dev/kvm \\\n  -v $(pwd):/workspace \\\n  -w /workspace/firecracker-sandbox \\\n  ubuntu:22.04 \\\n  bash -c \"\napt-get update -qq \u0026\u0026 apt-get install -y -qq curl tar e2fsprogs iproute2 iptables kmod openssh-client netcat-openbsd \u0026\u0026\ncurl -fsSL https://github.com/firecracker-microvm/firecracker/releases/download/v1.4.0/firecracker-v1.4.0-x86_64.tgz | tar -xz \u0026\u0026\nmv release-v1.4.0-x86_64/firecracker-v1.4.0-x86_64 /usr/local/bin/firecracker \u0026\u0026\nchmod +x /usr/local/bin/firecracker \u0026\u0026\ntests/quick-check.sh\n\"\n```\n\nThis runs all 7 unit tests with proper root privileges in an isolated container. No need for sudo on host.\n\nStatus: 3 of 6 sub-issues completed (dev-7ws, dev-8u9, dev-95y) - all tests passing.","status":"open","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-06T00:08:50.991632413+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T00:29:34.017115632+05:30","labels":["enhancement","firecracker-sandbox","testing"],"dependencies":[{"issue_id":"dev-7lq","depends_on_id":"dev-7ws","type":"blocks","created_at":"2026-02-06T00:20:40.954522942+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-7lq","depends_on_id":"dev-8u9","type":"blocks","created_at":"2026-02-06T00:20:41.444858214+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-7lq","depends_on_id":"dev-95y","type":"blocks","created_at":"2026-02-06T00:20:41.966708387+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-7lq","depends_on_id":"dev-18d","type":"blocks","created_at":"2026-02-06T00:20:42.272393156+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-7lq","depends_on_id":"dev-b4c","type":"blocks","created_at":"2026-02-06T00:20:42.713549726+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-7lq","depends_on_id":"dev-2vr","type":"blocks","created_at":"2026-02-06T00:20:42.954822379+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-7qq","title":"Building Ubuntu rootfs with debootstrap","description":"Use host debootstrap if /usr/share/debootstrap/scripts/\u003ccodename\u003e exists (e.g. noble, jammy, focal). Otherwise run debootstrap inside a Docker container: docker run -v \u003ctarget\u003e:/target ubuntu:\u003cversion\u003e with apt-get install debootstrap then debootstrap. Ensures compatibility when host is older than target Ubuntu version.","status":"closed","priority":4,"issue_type":"task","owner":"anandology@gmail.com","created_at":"2026-02-06T11:09:07.982758415+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T11:09:08.046773656+05:30","closed_at":"2026-02-06T11:09:08.046773656+05:30","close_reason":"note","labels":["howto","note"]}
{"id":"dev-7ws","title":"Test infrastructure: Create shared test utilities and helper libraries","description":"Create foundational test infrastructure in tests/lib/:\n\n- tests/lib/assert.sh - Assertion functions (assert_equals, assert_file_exists, assert_success, etc.)\n- tests/lib/cleanup.sh - Resource cleanup (kill VMs, remove TAPs, unmount filesystems)\n- tests/lib/vm-helpers.sh - VM operations (start_test_vm, wait_for_boot, check_running, etc.)\n\nThis provides the foundation for all other tests.\n\nAcceptance Criteria:\n- [ ] tests/lib/ directory structure created\n- [ ] assert.sh with at least 5 assertion functions\n- [ ] cleanup.sh with proper error handling\n- [ ] vm-helpers.sh with basic VM lifecycle functions\n- [ ] Each library has usage examples in comments\n- [ ] All functions have set -euo pipefail for safety","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-06T00:14:18.21548499+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T00:22:11.818585646+05:30","closed_at":"2026-02-06T00:22:11.818585646+05:30","close_reason":"Test infrastructure completed and verified - all tests passing","labels":["firecracker-sandbox","testing"]}
{"id":"dev-8qj","title":"Add vm.sh doctor command to diagnose VM environment health","description":"Add a `vm.sh doctor` command that inspects the current state of VMs, network devices, iptables rules, and running processes to identify inconsistencies and potential problems.\n\n## Motivation\n\nResources can get out of sync in many ways: manual deletion of VM directories, crashed VMs leaving stale state, TAP devices deleted without proper cleanup, etc. Currently there's no way to get a health overview — users have to manually inspect each piece.\n\n## Health Checks to Implement\n\n### 1. Stale PID files (HIGH priority)\n- For each VM with `state/vm.pid`, verify the process is actually alive (`kill -0`)\n- Report: \"VM '\u003cname\u003e' has stale PID file (process \u003cpid\u003e not running)\"\n- Suggest: `vm.sh down \u003cname\u003e` or manual removal of vm.pid\n\n### 2. Orphaned TAP devices (HIGH priority)\n- List all `tap-*` network interfaces on the system\n- Check if each has a corresponding VM directory with matching `state/tap_name.txt`\n- Report: \"TAP device 'tap-foo' exists but no VM 'foo' found\"\n- Suggest: `sudo ip link delete tap-foo`\n\n### 3. Missing TAP devices (HIGH priority)\n- For each built VM (has `state/built` marker), verify TAP device from `state/tap_name.txt` exists\n- Report: \"VM '\u003cname\u003e' is built but TAP device 'tap-\u003cname\u003e' is missing\"\n- Suggest: `sudo vm.sh build \u003cname\u003e` to rebuild\n\n### 4. Orphaned iptables FORWARD rules (MEDIUM priority)\n- List all iptables FORWARD rules matching `tap-*` interfaces\n- Check if each corresponds to an existing TAP device and VM\n- Report: \"iptables FORWARD rule for 'tap-foo' has no matching VM/device\"\n- Suggest: `sudo iptables -D FORWARD -i tap-foo -o \u003ciface\u003e -j ACCEPT`\n\n### 5. Missing iptables FORWARD rules (MEDIUM priority)\n- For each built VM with an existing TAP device, check the FORWARD rule exists\n- Report: \"VM '\u003cname\u003e' has TAP device but missing iptables FORWARD rule\"\n- Suggest: `sudo vm.sh build \u003cname\u003e` or manual rule addition\n\n### 6. IP address conflicts (HIGH priority)\n- Read `state/ip.txt` from all VMs, check for duplicates\n- Report: \"VMs '\u003cname1\u003e' and '\u003cname2\u003e' share IP 172.16.N.2\"\n- Suggest: Re-init one of the conflicting VMs\n\n### 7. Global NAT rules (MEDIUM priority)\n- Check MASQUERADE rule exists on host interface\n- Check conntrack FORWARD rule exists\n- Report: \"Global NAT rules missing — VMs won't have internet\"\n- Suggest: `sudo bin/setup.sh`\n\n### 8. Missing kernel (LOW priority)\n- Verify kernel file exists at expected path\n- Report: \"Kernel vmlinux-6.1.77 not found\"\n- Suggest: `sudo bin/setup.sh`\n\n### 9. State file consistency (MEDIUM priority)\n- For built VMs: verify `tap_name.txt`, `host_iface.txt`, `ip.txt`, `gateway.txt` all exist\n- Verify gateway IP in `gateway.txt` matches the actual IP on the TAP device\n- Report any mismatches\n\n### 10. Orphaned Firecracker processes (MEDIUM priority)\n- Find running `firecracker` processes on the system\n- Check if each has a corresponding VM with matching PID in `state/vm.pid`\n- Report: \"Firecracker process \u003cpid\u003e running with no matching VM\"\n\n### 11. Disk image checks (LOW priority)\n- For built VMs: verify `rootfs.ext4` and `home.ext4` exist\n- Report: \"VM '\u003cname\u003e' marked as built but missing rootfs.ext4\"\n\n## Output Format\n\n```\nChecking VM environment health...\n\n[PASS] Kernel vmlinux-6.1.77 found\n[PASS] Global NAT rules configured\n[PASS] No IP address conflicts\n[WARN] VM 'dev' has stale PID file (process 12345 not running)\n       → Run: vm.sh down dev\n[FAIL] TAP device 'tap-old' exists but no VM 'old' found\n       → Run: sudo ip link delete tap-old\n[FAIL] Orphaned iptables rule for tap-old\n       → Run: sudo iptables -D FORWARD -i tap-old -o eth0 -j ACCEPT\n\nSummary: 3 passed, 1 warning, 2 problems found\n```\n\nUse color output consistent with existing scripts: green for PASS, yellow for WARN, red for FAIL.\n\n## Sudo Handling\n\nThe doctor command should work in two modes:\n- **Without sudo**: Checks what it can (PID files, state file consistency, TAP device existence, IP conflicts, kernel, disk images)\n- **With sudo**: Additionally checks iptables rules (FORWARD rules, NAT rules, orphaned rules)\n\nWhen run without sudo, print a note: \"Run with sudo for full iptables diagnostics\"\n\n## Implementation Notes\n\n- Add `vm-doctor.sh` in `bin/` following existing script conventions\n- Register `doctor` subcommand in `vm.sh` dispatcher\n- No sudo required for the base command (consistent with other read-only commands like `list`, `status`)\n- Source `config.sh` for paths and constants\n- Each check should be a function for maintainability\n\n## Acceptance Criteria\n\n- [ ] `vm.sh doctor` runs without sudo and reports non-iptables checks\n- [ ] `sudo vm.sh doctor` runs all checks including iptables\n- [ ] Correctly identifies stale PID files\n- [ ] Correctly identifies orphaned/missing TAP devices\n- [ ] Correctly identifies IP conflicts\n- [ ] Correctly identifies missing global NAT rules (with sudo)\n- [ ] Correctly identifies orphaned iptables rules (with sudo)\n- [ ] Output uses color-coded PASS/WARN/FAIL format\n- [ ] Summary line at the end with counts\n- [ ] Each problem includes actionable suggestion","status":"in_progress","priority":2,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-07T09:59:25.197569276+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-07T10:50:12.702568755+05:30"}
{"id":"dev-8u9","title":"Build Alpine Linux test rootfs for fast integration tests","description":"Create bin/vm-build/build-alpine-rootfs.sh to build a lightweight Alpine test image:\n\n- Download Alpine minirootfs tarball\n- Configure static network (172.16.0.2/24 gateway 172.16.0.1)\n- Install OpenSSH server\n- Configure root authentication\n- Create ext4 image (~10MB)\n- Output: tests/images/alpine-test.ext4\n\nTarget: ~500ms boot time, ~10MB image size\n\nAcceptance Criteria:\n- [ ] Script downloads Alpine minirootfs automatically\n- [ ] Network configured correctly in /etc/network/interfaces\n- [ ] SSH server enabled and accessible\n- [ ] Image boots successfully in firecracker\n- [ ] Host can ping guest at 172.16.0.2\n- [ ] Image size under 15MB\n- [ ] Boot time under 1 second","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-06T00:14:22.754853183+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T00:22:11.823642444+05:30","closed_at":"2026-02-06T00:22:11.823642444+05:30","close_reason":"Test infrastructure completed and verified - all tests passing","labels":["firecracker-sandbox","testing"]}
{"id":"dev-95y","title":"Implement unit tests for host prerequisites and setup","description":"Create fast unit tests that validate host configuration without booting VMs:\n\ntests/unit/test-kvm-access.sh - Verify /dev/kvm access\ntests/unit/test-host-tools.sh - Check required tools present\ntests/unit/test-tap-create.sh - Test TAP device creation\ntests/unit/test-tap-ip.sh - Test TAP IP configuration\ntests/unit/test-ip-forward.sh - Verify IP forwarding\ntests/unit/test-nat-rules.sh - Test NAT/MASQUERADE rules\n\nAlso create tests/quick-check.sh runner that runs all unit tests.\n\nTarget: Complete suite in \u003c15 seconds\n\nAcceptance Criteria:\n- [ ] All 6 unit tests created and executable\n- [ ] Each test has clear PASS/FAIL output\n- [ ] Tests clean up resources after themselves\n- [ ] quick-check.sh runs all unit tests\n- [ ] Total runtime under 15 seconds\n- [ ] Tests use assert.sh and cleanup.sh libraries","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-06T00:14:27.614537507+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T00:22:11.828455488+05:30","closed_at":"2026-02-06T00:22:11.828455488+05:30","close_reason":"Test infrastructure completed and verified - all tests passing","labels":["firecracker-sandbox","testing"]}
{"id":"dev-97q","title":"test-vm-boot-alpine.sh incorrectly fails - Firecracker boots successfully","description":"## Problem\n\nThe test `tests/integration/test-vm-boot-alpine.sh` reports failure saying \"Firecracker process exited\", but Firecracker actually starts successfully and boots the VM.\n\n## Root Cause\n\nThe test starts Firecracker in background and checks if the process is still running after 2 seconds:\n\n```bash\nfirecracker --api-sock \"$SOCKET_PATH\" --config-file \"config.json\" \u003e/dev/null 2\u003e\u00261 \u0026\nFC_PID=$!\nsleep 2\nps -p $FC_PID  # Fails because firecracker runs in foreground\n```\n\nWhen Firecracker is started with `--config-file`, it:\n1. Loads the configuration\n2. Starts the VM immediately (blocking/foreground)\n3. VM boots and runs\n\nThe process does NOT stay in background - it runs the VM in the foreground. The test incorrectly interprets this as a failure.\n\n## Evidence\n\nManual test shows Firecracker starts successfully:\n```\n2026-02-05T19:24:13.379812566 [anonymous-instance:main] Running Firecracker v1.7.0\n2026-02-05T19:24:13.455001468 [anonymous-instance:main] Artificially kick devices.\n2026-02-05T19:24:13.455070550 [anonymous-instance:main] Successfully started microvm\n[    0.000000] Linux version 6.1.77 ...\n[    0.000000] Command line: console=ttyS0 reboot=k panic=1 pci=off root=/dev/vda rw\n```\n\n## How to Reproduce\n\n```bash\ncd firecracker-sandbox\n./tests/docker/run-tests.sh \"bin/vm-build/build-alpine-rootfs.sh \u0026\u0026 tests/integration/test-vm-boot-alpine.sh\"\n```\n\n## Expected Behavior\n\nTest should either:\n1. Use Firecracker API mode (start without --config-file, use API to configure)\n2. Run Firecracker in foreground and check output for success messages\n3. Check for socket file creation instead of process existence\n\n## Fix Options\n\n**Option 1**: Use API mode\n```bash\nfirecracker --api-sock $SOCKET_PATH \u0026\nFC_PID=$!\n# Wait for socket\n# Use API to configure and start VM\n```\n\n**Option 2**: Check success differently\n```bash\ntimeout 10 firecracker --api-sock $SOCKET_PATH --config-file config.json 2\u003e\u00261 | grep -q \"Successfully started microvm\"\n```\n\n## Test Command\n```bash\n./tests/docker/run-tests.sh \"bin/vm-build/build-alpine-rootfs.sh \u0026\u0026 tests/integration/test-vm-boot-alpine.sh\"\n```","status":"closed","priority":2,"issue_type":"bug","assignee":"Anand Chitipothu","owner":"anandology@gmail.com","created_at":"2026-02-06T00:56:05.957580467+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T01:13:48.292027473+05:30","closed_at":"2026-02-06T01:13:48.292027473+05:30","close_reason":"Closed","labels":["bug","firecracker-sandbox","testing"]}
{"id":"dev-a9j","title":"packages.nix should use actual Nix expression format","description":"The current packages.nix file uses a misleading format - it's just space-separated package names, not actual Nix code.\n\n**Current Implementation:**\n- File is named packages.nix but contains plain text: `go_1_24 nodejs`\n- Script parses it and runs: `nix-env -iA nixpkgs.\u003cpackage\u003e` for each\n- Package names may be incorrect (e.g., go_1_24 might not be a valid nixpkgs attribute)\n\n**Problems:**\n1. Misleading filename - .nix extension suggests Nix expression\n2. Package names are hard to verify (need to manually check nixpkgs)\n3. No validation - users don't know if names are correct until first boot fails\n4. Can't use Nix expressions or compose packages\n\n**Proposed Solution:**\nUse proper Nix expression format:\n\n```nix\n# packages.nix\n{ pkgs ? import \u003cnixpkgs\u003e {} }:\n\nwith pkgs; [\n  go\n  nodejs\n  python3\n  postgresql\n  tmux\n  vim\n]\n```\n\nThen install with: `nix-env -iA -f packages.nix`\n\n**Benefits:**\n1. Proper Nix syntax - users can validate with `nix-instantiate --eval packages.nix`\n2. Correct package names from nixpkgs\n3. Can use Nix expressions, overrides, and composition\n4. IDE support and syntax highlighting\n5. Consistent with Nix ecosystem conventions\n\n**Alternative:**\nIf simplicity is preferred, rename to `nix-packages.txt` and document it's plain text, not Nix code.\n\n**Files to Change:**\n- bin/vm-init.sh (generate proper Nix expression)\n- bin/first-boot.sh (use `nix-env -iA -f packages.nix`)\n- Documentation/examples","status":"closed","priority":2,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-05T21:47:27.981964004+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T21:49:36.836933814+05:30","closed_at":"2026-02-05T21:49:36.836933814+05:30","close_reason":"Closed"}
{"id":"dev-aq9","title":"Firecracker VM Management Framework","description":"Create a simple, lightweight framework for managing Firecracker VMs targeted at individual developers. The framework should support:\n- One-time system setup with minimal friction\n- Easy VM creation from templates\n- Sudo-less daily VM operations (start/stop/ssh)\n- Multiple simultaneous VMs with bridge networking\n- Ubuntu 24.04 base images with customizable packages\n- Clean system cleanup to completely remove the framework when no longer needed\n\nKey outcomes:\n- Developers can create isolated VM environments for AI agent testing\n- Fast VM boot times (~1 second)\n- Clean separation between privileged setup and daily operations\n- Persistent user-owned TAP devices enabling sudo-less VM management\n- Easy uninstall path - complete removal of bridge, TAP devices, and VM instances","status":"closed","priority":1,"issue_type":"epic","owner":"anandology@gmail.com","created_at":"2026-02-05T17:41:32.465128883+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:09:02.384845442+05:30","closed_at":"2026-02-05T19:09:02.384848425+05:30"}
{"id":"dev-aq9.1","title":"Global Setup \u0026 Cleanup Scripts","description":"Create global system setup and cleanup infrastructure for the Firecracker VM framework.\n\n**Scope:**\n\n1. **bin/config.sh** - Global configuration file\n   - BRIDGE_NAME=\"br-firecracker\"\n   - BRIDGE_IP=\"172.16.0.1/24\"\n   - FIRECRACKER_VERSION=\"v1.7.0\" (or latest)\n   - HOST_IFACE detection for NAT\n\n2. **bin/setup.sh** - One-time system setup (requires sudo)\n   - Download firecracker binary to bin/firecracker\n   - Verify KVM support and prerequisites\n   - Create systemd service file at /etc/systemd/system/firecracker-bridge.service\n     * Service contains bridge creation logic (ip link add, ip addr add, iptables rules, ip forwarding)\n     * Type=oneshot with RemainAfterExit=yes\n     * ExecStart creates bridge and NAT rules\n     * ExecStop tears down bridge\n   - systemctl daemon-reload\n   - systemctl enable firecracker-bridge (auto-start on boot)\n   - systemctl start firecracker-bridge (create bridge now)\n   - Create state/bridge symlink to /sys/class/net/br-firecracker\n   - Bridge persists across reboots automatically\n\n3. **bin/cleanup.sh** - System-wide cleanup (requires sudo)\n   - Stop all running VMs\n   - Destroy all VM instances (calls vm.sh destroy for each)\n   - systemctl stop firecracker-bridge\n   - systemctl disable firecracker-bridge\n   - Remove /etc/systemd/system/firecracker-bridge.service\n   - systemctl daemon-reload\n   - Remove state directory\n\n**State Management:**\n- state/bridge -\u003e /sys/class/net/br-firecracker (symlink indicates bridge exists)\n- Broken symlink = bridge doesn't exist\n\n**Systemd Service:**\nBridge creation logic lives in the systemd service, not duplicated in setup.sh. This ensures:\n- Single source of truth for bridge management\n- Automatic bridge recreation on reboot\n- Clean service lifecycle management\n\n**Acceptance Criteria:**\n- setup.sh completes successfully on fresh Ubuntu system\n- Bridge is created and accessible at 172.16.0.1\n- Firecracker binary is executable and has correct permissions\n- systemctl status firecracker-bridge shows active\n- Bridge survives system reboot\n- cleanup.sh removes all traces: service, bridge, state\n- Scripts have clear error messages and validation","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T17:54:20.465337006+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:49.687714431+05:30","closed_at":"2026-02-05T19:08:49.687718329+05:30","dependencies":[{"issue_id":"dev-aq9.1","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T17:54:20.466989655+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.10","title":"VM SSH Command (vm-ssh.sh)","description":"Implement VM ssh command to connect to a running VM.\n\n**Command:** `~/vms/vm.sh ssh \u003cname\u003e [ssh-args]` (no sudo required)\n\n**Scope:**\n\n1. **Validation**\n   - Check VM exists\n   - Check VM is running (validate state/vm.pid)\n   - If not running, error: \"VM 'name' is not running. Start it with: ~/vms/vm.sh up \u003cname\u003e\"\n   - Load config.sh and state files\n\n2. **Read Connection Info**\n   - Get IP from state/ip.txt\n   - Get USERNAME from config.sh\n   - Get SSH key path from config.sh or use default\n\n3. **Execute SSH Connection**\n   - Build SSH command with proper options:\n     ```bash\n     exec ssh -o StrictHostKeyChecking=no \\\n              -o UserKnownHostsFile=/dev/null \\\n              -i \u003cssh_key_path\u003e \\\n              \u003cusername\u003e@\u003cip\u003e \\\n              \"$@\"\n     ```\n   - Use exec to replace current process (clean exit)\n   - Pass through any additional arguments (e.g., commands, -L for port forwarding)\n\n4. **Support Remote Commands**\n   - `vm.sh ssh claude` - Interactive shell\n   - `vm.sh ssh claude \"ls -la\"` - Run command\n   - `vm.sh ssh claude -L 5432:localhost:5432` - Port forwarding\n\n**No Sudo Required:**\n- Pure SSH connection\n- Uses user's SSH key\n\n**Error Handling:**\n- Clear error if VM not running\n- SSH connection errors pass through\n- Helpful message if SSH key not found\n\n**Acceptance Criteria:**\n- Connects to running VM without sudo\n- Opens interactive shell by default\n- Supports passing commands and SSH arguments\n- Clean error if VM not running\n- Works with custom SSH keys from config\n- Port forwarding works","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:47:52.564689895+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:57.56309246+05:30","closed_at":"2026-02-05T19:08:57.563095948+05:30","dependencies":[{"issue_id":"dev-aq9.10","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:47:52.566611947+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-aq9.10","depends_on_id":"dev-aq9.8","type":"blocks","created_at":"2026-02-05T18:48:40.74558949+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.11","title":"VM Status Command (vm-status.sh)","description":"Implement VM status command to show detailed information about a single VM.\n\n**Command:** `~/vms/vm.sh status \u003cname\u003e` (no sudo required)\n\n**Scope:**\n\n1. **Validation**\n   - Check VM exists\n   - Load config.sh and state files\n   - Handle missing files gracefully\n\n2. **Gather VM Information**\n   - VM name (directory name)\n   - Status: pending/stopped/running/crashed\n   - IP address (from state/ip.txt)\n   - TAP device (from state/tap_name.txt or derive)\n   - Resources: CPUs, Memory (from config.sh)\n   - Disk images: rootfs.ext4 and home.ext4 sizes\n   - Username (from config.sh)\n   \n3. **Running VM Details** (if status = running)\n   - PID (from state/vm.pid)\n   - Uptime (calculate from process start time)\n   - Memory usage (from /proc/\u003cpid\u003e/status)\n   - CPU usage (if easily available)\n   - SSH connectivity: test if SSH port is reachable\n\n4. **Display Format**\n   - Show information in clear, readable format:\n     ```\n     VM: claude\n     Status: running\n     IP: 172.16.0.2\n     Username: anand\n     Uptime: 2h 34m\n     \n     Resources:\n       CPUs: 4\n       Memory: 8192 MB (2.3 GB used)\n       TAP device: tap-claude\n     \n     Disks:\n       Root: 8.0 GB (~/vms/vms/claude/rootfs.ext4)\n       Home: 20.0 GB (~/vms/vms/claude/home.ext4)\n     \n     Process:\n       PID: 12345\n     \n     SSH: ssh anand@172.16.0.2\n     ```\n\n5. **Pending Status Display**\n   - Show limited info if VM not built yet:\n     ```\n     VM: postgres\n     Status: pending (not built)\n     IP: 172.16.0.4 (assigned)\n     \n     Config: ~/vms/vms/postgres/config.sh\n     Next: sudo ~/vms/vm.sh build postgres\n     ```\n\n6. **Error States**\n   - Show helpful messages for crashed/stale state\n   - Suggest recovery commands\n\n**No Sudo Required:**\n- Read-only operations\n- Uses /proc for process info\n\n**Acceptance Criteria:**\n- Shows comprehensive VM information\n- Works for all VM states (pending/stopped/running/crashed)\n- Clean, readable output format\n- Shows resource usage for running VMs\n- Calculates uptime correctly\n- Handles missing/corrupted state gracefully\n- Provides helpful next steps for each state","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:48:10.135220812+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:58.133380933+05:30","closed_at":"2026-02-05T19:08:58.133385516+05:30","dependencies":[{"issue_id":"dev-aq9.11","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:48:10.13771271+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.12","title":"Package Distribution Script (package.sh)","description":"Create packaging script to generate vms.zip for distribution.\n\n**Goal:** Package the framework into vms.zip that users can extract to ~/vms/\n\n**Scope:**\n\n1. **Create package.sh Script**\n   - Lives at firecracker-sandbox/package.sh\n   - Creates vms.zip with proper structure\n   - Excludes development files\n\n2. **Package Contents**\n   - Include:\n     * vm.sh (main entry point)\n     * bin/ directory (all scripts)\n     * lib/ directory (helper functions)\n     * README.md (user documentation)\n   - Exclude:\n     * notes.md (internal design doc)\n     * package.sh itself\n     * .git files\n     * state/, kernels/, vms/ (created at runtime)\n     * Editor temp files (*.swp, *~, .DS_Store)\n\n3. **Packaging Script**\n   ```bash\n   #!/bin/bash\n   set -e\n   \n   cd \"$(dirname \"$0\")\"\n   \n   echo \"Creating vms.zip...\"\n   \n   zip -r vms.zip \\\n     vm.sh \\\n     bin/ \\\n     lib/ \\\n     README.md \\\n     -x \"*.swp\" \"*~\" \".DS_Store\" \".git/*\" \"__pycache__/*\"\n   \n   echo \"✓ Created vms.zip\"\n   echo \"Users can extract with: unzip vms.zip -d ~/vms\"\n   ```\n\n4. **Version Tracking** (optional)\n   - Include VERSION file in package\n   - Show version in vm.sh --version\n\n5. **Validation**\n   - Check all required files exist before packaging\n   - Verify vm.sh is executable\n   - Test that zip can be extracted cleanly\n\n**User Workflow After This Issue:**\n```bash\n# Developer creates package\ncd firecracker-sandbox\n./package.sh\n\n# User installs\nunzip vms.zip -d ~/\ncd ~/vms\nsudo bin/setup.sh\n```\n\n**Acceptance Criteria:**\n- package.sh creates valid vms.zip\n- zip contains all necessary files\n- zip excludes development/runtime files\n- Extracted structure works correctly\n- README.md includes installation instructions\n- Script has proper error handling","status":"closed","priority":2,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:56:46.950311385+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:58.671434624+05:30","closed_at":"2026-02-05T19:08:58.671437834+05:30","dependencies":[{"issue_id":"dev-aq9.12","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:56:46.952656804+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.2","title":"VM CLI Dispatcher (vm.sh skeleton)","description":"Create the main vm.sh dispatcher that routes commands to specialized scripts.\n\n**Scope:**\n\n1. **vm.sh** - Main entry point script\n   - Command parsing and argument handling\n   - Route commands to bin/vm-\u003ccommand\u003e.sh scripts\n   - Pass VM name and additional arguments to sub-scripts\n   - Error handling for unknown commands\n   - Help/usage message\n\n**Command Routing:**\n```\n~/vms/vm.sh create \u003cname\u003e [args]  → bin/vm-create.sh \u003cname\u003e [args]\n~/vms/vm.sh up \u003cname\u003e              → bin/vm-up.sh \u003cname\u003e\n~/vms/vm.sh down \u003cname\u003e            → bin/vm-down.sh \u003cname\u003e\n~/vms/vm.sh ssh \u003cname\u003e [args]      → bin/vm-ssh.sh \u003cname\u003e [args]\n~/vms/vm.sh status \u003cname\u003e          → bin/vm-status.sh \u003cname\u003e\n~/vms/vm.sh list                   → bin/vm-list.sh\n~/vms/vm.sh destroy \u003cname\u003e         → bin/vm-destroy.sh \u003cname\u003e\n```\n\n**Implementation:**\n- Use case statement for command dispatching\n- Use exec to replace current process with sub-script (clean process tree)\n- Preserve exit codes from sub-scripts\n- Source bin/config.sh for global configuration access\n\n**Validation:**\n- Check command is recognized\n- For commands requiring \u003cname\u003e, validate name is provided\n- Show helpful error messages with usage examples\n\n**Acceptance Criteria:**\n- vm.sh routes all commands correctly\n- Unknown commands show clear error and usage\n- Missing arguments show helpful error messages\n- Exit codes from sub-scripts are preserved\n- Help message lists all available commands","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:05:54.894135287+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:50.192591365+05:30","closed_at":"2026-02-05T19:08:50.192594272+05:30","dependencies":[{"issue_id":"dev-aq9.2","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:05:54.896300298+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.3","title":"VM Build Command (vm-build.sh)","description":"Implement VM build command that reads config.sh and builds a minimal base VM instance.\n\n**Command:** `sudo ~/vms/vm.sh build \u003cname\u003e`\n\n**Prerequisites:**\n- VM must be initialized (vm init \u003cname\u003e already run)\n- config.sh exists and has been edited by user\n\n**Scope:**\n\n1. **Validation**\n   - Check VM exists (~/vms/vms/\u003cname\u003e/ directory exists)\n   - Check config.sh exists and is readable\n   - Check not already built (no rootfs.ext4)\n   - Check bridge is set up\n   - Requires sudo\n\n2. **Load Configuration**\n   - Source ~/vms/vms/\u003cname\u003e/config.sh\n   - Read: USERNAME, SSH_KEY_PATH, UBUNTU_VERSION, CPUS, MEMORY, ROOTFS_SIZE, HOME_SIZE\n   - Read IP from ~/vms/vms/\u003cname\u003e/state/ip.txt\n   - Validate all required settings present\n\n3. **Download Kernel** (shared, cached)\n   - Download vmlinux if not already at ~/vms/kernels/vmlinux-6.1.58\n   - Source: GitHub releases or specific URL (from bin/config.sh)\n   - Reused across all VMs\n\n4. **Build Base Rootfs with debootstrap**\n   - Use debootstrap to create minimal Ubuntu filesystem (version from config)\n   - Install ONLY base packages: systemd, openssh-server, linux-image-virtual\n   - Configure systemd-networkd with static IP for eth0 (from state/ip.txt)\n   - Set hostname to \u003cname\u003e (directory name)\n   - Create user account with USERNAME from config\n   - Enable SSH service\n   - Create ext4 filesystem image (ROOTFS_SIZE from config)\n   - Save as ~/vms/vms/\u003cname\u003e/rootfs.ext4\n   - Set ownership to $SUDO_USER\n\n5. **SSH Key Setup**\n   - Read SSH key from SSH_KEY_PATH (from config)\n   - Cache in ~/vms/vms/\u003cname\u003e/ssh_key.pub\n   - Mount rootfs and inject key into user's authorized_keys\n   - Also add to root's authorized_keys\n   - Unmount\n\n6. **Create Home Volume**\n   - Create empty ext4 image for /home\n   - Size from HOME_SIZE in config\n   - Save as ~/vms/vms/\u003cname\u003e/home.ext4\n   - Set ownership to $SUDO_USER\n\n7. **Create TAP Device** (requires sudo)\n   - Create dedicated TAP: tap-\u003cname\u003e\n   - Set ownership to $SUDO_USER: `ip tuntap add tap-\u003cname\u003e mode tap user \"$SUDO_USER\"`\n   - Attach to br-firecracker\n   - Bring up\n   - Save TAP name to state/tap_name.txt\n\n8. **Mark as Built**\n   - Create state/built marker file with timestamp\n   - Set all ownership to $SUDO_USER\n\n**Directory Structure After Build:**\n```\n~/vms/vms/\u003cname\u003e/\n├── state/\n│   ├── ip.txt           # Created during init\n│   ├── tap_name.txt     # Created during build\n│   └── built            # Marker that build completed\n├── config.sh            # Created during init, edited by user\n├── apt-packages.txt     # Created during init, read during first boot\n├── packages.nix         # Created during init, read during first boot\n├── ssh_key.pub          # Cached SSH key\n├── rootfs.ext4          # Minimal base image (fast to build)\n└── home.ext4            # Empty home volume\n```\n\n**Notes:**\n- Build creates MINIMAL base image only (no apt packages, no Nix)\n- Package installation happens during first boot (separate feature)\n- Build is fast and repeatable\n- Requires sudo for TAP device creation and debootstrap\n- All created files owned by $SUDO_USER for sudo-less daily operations\n\n**Acceptance Criteria:**\n- Creates minimal working Ubuntu VM with SSH access\n- User account created with USERNAME from config\n- SSH key injected correctly from SSH_KEY_PATH\n- systemd-networkd configured with correct IP\n- TAP device owned by calling user\n- VM status changes from \"pending\" to \"stopped\" after build\n- Build completes quickly (no package installation)\n- Clear error messages for missing config or invalid settings","notes":"\n**First-Boot Integration:**\n- Copy ~/vms/bin/first-boot.sh to rootfs at /first-boot.sh (world-readable, executable)\n- Copy apt-packages.txt and packages.nix to /home/\u003cusername\u003e/ in rootfs\n- vm up will execute /first-boot.sh if present, then delete it\n- For this issue: create a dummy/stub first-boot.sh that just exits 0\n- Actual first-boot.sh implementation is separate issue (dev-aq9.7)\n\n**First-Boot Integration:**\n- Copy ~/vms/bin/first-boot.sh to rootfs at /first-boot.sh (world-readable, executable)\n- Copy apt-packages.txt and packages.nix to /home/\u003cusername\u003e/ in rootfs\n- vm up will execute /first-boot.sh if present, then delete it\n- For this issue: create a dummy/stub first-boot.sh that just exits 0\n- Actual first-boot.sh implementation is separate issue (dev-aq9.7)","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:13:40.061834221+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:50.943186804+05:30","closed_at":"2026-02-05T19:08:50.94319091+05:30","dependencies":[{"issue_id":"dev-aq9.3","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:13:40.063572551+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-aq9.3","depends_on_id":"dev-aq9.6","type":"blocks","created_at":"2026-02-05T18:48:40.399346183+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-aq9.3","depends_on_id":"dev-aq9.1","type":"blocks","created_at":"2026-02-05T18:48:40.456492842+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.4","title":"VM List Command (vm-list.sh)","description":"Implement VM list command to show all VMs and their status.\n\n**Command:** `~/vms/vm.sh list`\n\n**Scope:**\n\n1. **Scan VM Directories**\n   - Iterate through ~/vms/vms/*/ directories\n   - VM name = directory basename\n   - Skip if not a directory or no state/ subdirectory\n\n2. **Gather VM Information**\n   - Read IP from vms/\u003cname\u003e/state/ip.txt\n   - Determine status:\n     * **pending**: has config.sh but no rootfs.ext4\n     * **running**: has rootfs.ext4 and state/vm.pid with alive process\n     * **stopped**: has rootfs.ext4 but no vm.pid or dead process\n     * **crashed**: has vm.pid but process is dead (stale pid)\n   - Calculate uptime if running (process start time)\n   - Handle missing state gracefully\n\n3. **Display Table**\n   - Format: NAME, IP, STATUS, UPTIME\n   - Example output:\n     ```\n     NAME        IP              STATUS      UPTIME\n     dev         172.16.0.2      pending     -\n     claude      172.16.0.3      running     2h 34m\n     postgres    172.16.0.4      stopped     -\n     test        172.16.0.5      crashed     -\n     ```\n   - Sort by name alphabetically\n   - Show message if no VMs exist\n\n4. **Status Detection Logic**\n   - pending: config.sh exists, rootfs.ext4 doesn't exist\n   - running: rootfs.ext4 exists, vm.pid exists, process alive\n   - stopped: rootfs.ext4 exists, no vm.pid or clean shutdown\n   - crashed: rootfs.ext4 exists, vm.pid exists, process dead\n\n**Requirements:**\n- No sudo required\n- Works even if some VMs have incomplete state\n- Clean error handling for corrupted state\n\n**Acceptance Criteria:**\n- Lists all VMs with correct status including pending\n- Uptime calculated accurately for running VMs\n- Handles edge cases (missing files, stale pids)\n- Clean tabular output\n- Shows pending VMs (initialized but not built)","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:16:46.455579474+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:51.35171976+05:30","closed_at":"2026-02-05T19:08:51.351723388+05:30","dependencies":[{"issue_id":"dev-aq9.4","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:16:46.457600057+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.5","title":"VM Destroy Command (vm-destroy.sh)","description":"Implement VM destroy command to completely remove a VM instance.\n\n**Command:** `sudo ~/vms/vm.sh destroy \u003cname\u003e`\n\n**Scope:**\n\n1. **Root Check**\n   - Check if running as root (EUID = 0)\n   - Exit with error if not: \"Error: vm destroy requires sudo\"\n   - Must be first check before any operations\n\n2. **Validation**\n   - Check VM exists (~/vms/vms/\u003cname\u003e/ directory exists)\n   - Load VM state from vms/\u003cname\u003e/state/\n\n3. **Confirmation** (Optional but recommended)\n   - Warn about data loss (home.ext4 will be deleted)\n   - Ask for confirmation: \"Destroy VM '\u003cname\u003e'? This will delete all data. [y/N]\"\n   - Support --force flag to skip confirmation\n\n4. **Stop VM if Running**\n   - Check if VM is running (state/vm.pid)\n   - If running, stop gracefully first\n   - Wait for shutdown (timeout 30s)\n   - Kill forcefully if doesn't stop\n\n5. **Remove TAP Device** (requires sudo)\n   - Read TAP name from state/tap_name.txt or derive as tap-\u003cname\u003e\n   - Delete TAP: `ip link delete tap-\u003cname\u003e`\n   - Handle error if TAP doesn't exist (non-fatal)\n\n6. **Delete VM Files**\n   - Remove entire ~/vms/vms/\u003cname\u003e/ directory:\n     * rootfs.ext4\n     * home.ext4 (data loss!)\n     * config.sh\n     * state/ directory and all contents\n   - Use rm -rf (careful!)\n\n7. **Cleanup Ownership**\n   - All operations as root, but ensure clean removal\n\n**Requirements:**\n- MUST run as root (sudo)\n- Confirmation before destructive operations\n- Graceful VM shutdown before removal\n- Clear error messages\n\n**Acceptance Criteria:**\n- Errors immediately if not run as root\n- Successfully removes all VM files and TAP device\n- Stops running VM before removal\n- Confirmation prompt works (skippable with --force)\n- Handles edge cases (already stopped, TAP missing, etc.)\n- No traces of VM left after destroy","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:17:00.38159893+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:51.917199054+05:30","closed_at":"2026-02-05T19:08:51.917202446+05:30","dependencies":[{"issue_id":"dev-aq9.5","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:17:00.383905133+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-aq9.5","depends_on_id":"dev-aq9.3","type":"blocks","created_at":"2026-02-05T18:48:40.81311381+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-aq9.5","depends_on_id":"dev-aq9.9","type":"blocks","created_at":"2026-02-05T18:48:40.87192314+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.6","title":"VM Init Command (vm-init.sh)","description":"Implement VM initialization command to create configuration without building.\n\n**Command:** `~/vms/vm.sh init \u003cname\u003e`\n\n**Scope:**\n\n1. **Validation**\n   - Check VM name is valid (alphanumeric, hyphens, underscores)\n   - Check VM doesn't already exist (~/vms/vms/\u003cname\u003e/ not present)\n   - Check bridge is set up (state/bridge symlink exists)\n   - No sudo required\n\n2. **Create VM Directory Structure**\n   - mkdir -p ~/vms/vms/\u003cname\u003e/state/\n   - VM name = directory basename = hostname\n\n3. **Auto-assign IP**\n   - Scan existing VMs state/ip.txt files\n   - Assign next available IP (.2, .3, .4, etc.)\n   - Save to ~/vms/vms/\u003cname\u003e/state/ip.txt\n   - Validate IP not in use\n\n4. **Detect SSH Key**\n   - Search for SSH public keys in ~/.ssh/\n   - Look for: id_ed25519.pub, id_rsa.pub, id_ecdsa.pub (in that order)\n   - Use first found key\n   - If no key found, leave SSH_KEY_PATH commented with helpful message\n\n5. **Detect Username**\n   - Set to current user ($USER)\n\n6. **Generate config.sh Template**\n   - Create ~/vms/vms/\u003cname\u003e/config.sh:\n     ```bash\n     # VM Configuration for \u003cname\u003e\n     # Edit this file, then run: sudo ~/vms/vm.sh build \u003cname\u003e\n     \n     # Resources\n     CPUS=4\n     MEMORY=8192\n     ROOTFS_SIZE=\"8G\"\n     HOME_SIZE=\"20G\"\n     \n     # User setup\n     USERNAME=\"\u003cdetected-user\u003e\"\n     SSH_KEY_PATH=\"\u003cdetected-key-path\u003e\"\n     \n     # Ubuntu version\n     UBUNTU_VERSION=\"24.04\"  # noble\n     ```\n\n7. **Generate Package Files**\n   - Create ~/vms/vms/\u003cname\u003e/apt-packages.txt:\n     ```\n     # APT packages to install (one per line)\n     # Lines starting with # are comments\n     \n     podman\n     postgresql\n     tmux\n     vim\n     git\n     curl\n     ```\n   - Create ~/vms/vms/\u003cname\u003e/packages.nix:\n     ```\n     # Nix packages to install (space-separated)\n     go_1_24 nodejs\n     ```\n\n8. **Print Success Message**\n   - Show config file location\n   - Show package files location\n   - Show next steps: edit files, then run build\n   - Example: \n     ```\n     ✓ Initialized VM 'claude' with IP 172.16.0.2\n       Config: ~/vms/vms/claude/config.sh\n       Packages: ~/vms/vms/claude/apt-packages.txt\n       Nix: ~/vms/vms/claude/packages.nix\n       Next: sudo ~/vms/vm.sh build claude\n     ```\n\n**Status in vm list:**\n- After init, VM appears as \"pending\" status\n- pending = has config.sh but no rootfs.ext4\n\n**Acceptance Criteria:**\n- Creates directory structure without sudo\n- Auto-assigns unique IP\n- Detects and sets SSH_KEY_PATH automatically\n- Sets USERNAME to current user\n- Generated config.sh is valid and editable\n- Generated apt-packages.txt and packages.nix with sensible defaults\n- VM appears as \"pending\" in vm list\n- Clear next steps shown to user","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:31:41.38496251+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:52.458229719+05:30","closed_at":"2026-02-05T19:08:52.458233273+05:30","dependencies":[{"issue_id":"dev-aq9.6","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:31:41.386990188+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-aq9.6","depends_on_id":"dev-aq9.1","type":"blocks","created_at":"2026-02-05T18:48:40.344132451+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.7","title":"First-Boot Automation \u0026 Package Installation","description":"Implement bin/first-boot.sh script that installs packages on first VM boot.\n\n**Location:** ~/vms/bin/first-boot.sh (copied to /first-boot.sh in VM during build)\n\n**Execution:** Runs inside the VM on first boot (triggered by vm up)\n\n**Scope:**\n\n1. **Script Location \u0026 Integration**\n   - Lives at ~/vms/bin/first-boot.sh on host\n   - Build copies it to /first-boot.sh in rootfs\n   - vm up executes it via SSH if present, then deletes it\n   - Runs as root inside the VM\n\n2. **Read Package Files**\n   - apt-packages.txt and packages.nix are in /home/\u003cusername\u003e/ (copied during build)\n   - Read and parse both files\n   - Skip comments (#) and empty lines in apt-packages.txt\n   - Parse space-separated package names in packages.nix\n\n3. **Install APT Packages**\n   - Run: apt-get update\n   - Install packages from apt-packages.txt one by one\n   - Continue on errors (log failed packages)\n   - Example: apt-get install -y podman postgresql tmux\n\n4. **Install Nix Package Manager**\n   - Download and run Nix installer as the user:\n     ```bash\n     su - \u003cusername\u003e -c 'curl -L https://nixos.org/nix/install | sh -s -- --daemon'\n     ```\n   - Verify Nix installation\n   - Source Nix profile\n\n5. **Install Nix Packages**\n   - Install packages from packages.nix as the user\n   - Run: su - \u003cusername\u003e -c 'nix-env -iA nixpkgs.\u003cpackage\u003e'\n   - Continue on errors (log failed packages)\n\n6. **Logging**\n   - Log all output to /var/log/first-boot.log\n   - Include timestamps\n   - Log both stdout and stderr\n   - Exit code 0 on success (even with some package failures)\n\n7. **Progress Indicators**\n   - Echo progress messages (vm up will show them via SSH)\n   - Example output:\n     ```\n     Installing APT packages...\n     - podman: OK\n     - postgresql: OK\n     Installing Nix...\n     - Nix installed successfully\n     Installing Nix packages...\n     - go_1_24: OK\n     - nodejs: OK\n     First-boot setup complete\n     ```\n\n**Error Handling:**\n- Continue on individual package failures\n- Log errors but don't fail entire script\n- Exit 0 unless critical failure (apt-get update fails, Nix install fails)\n\n**Self-Deletion:**\n- vm up deletes /first-boot.sh after execution\n- Script doesn't need to delete itself\n\n**Testing:**\n- Can be tested independently in a VM\n- Should work with empty package files\n- Should handle missing package files gracefully\n\n**Acceptance Criteria:**\n- Installs all APT packages successfully\n- Installs Nix successfully\n- Installs all Nix packages successfully\n- Logs to /var/log/first-boot.log\n- Clear progress output\n- Handles errors gracefully (continues on package failures)\n- Works when package files are empty or missing","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:40:00.199751665+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:56.014130255+05:30","closed_at":"2026-02-05T19:08:56.014133808+05:30","dependencies":[{"issue_id":"dev-aq9.7","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:40:00.201448162+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.8","title":"VM Up Command (vm-up.sh)","description":"Implement VM up command to start a VM and make it ready for use.\n\n**Command:** `~/vms/vm.sh up \u003cname\u003e` (no sudo required)\n\n**Prerequisites:**\n- VM must be built (rootfs.ext4 exists)\n- Bridge and TAP device already set up\n\n**Scope:**\n\n1. **Validation**\n   - Check VM exists and is built (rootfs.ext4 present)\n   - Check not already running (no valid vm.pid)\n   - Load config.sh and state files (ip.txt, tap_name.txt)\n   - Check TAP device exists and is owned by current user\n\n2. **Check IP Conflict**\n   - Scan other VMs to ensure GUEST_IP not in use by running VM\n   - Error if conflict detected\n\n3. **Start Firecracker VM**\n   - Build firecracker config JSON with:\n     * Kernel path (from ~/vms/kernels/)\n     * Rootfs path (~/vms/vms/\u003cname\u003e/rootfs.ext4)\n     * Home drive path (~/vms/vms/\u003cname\u003e/home.ext4) mounted as /home\n     * Network: TAP device (tap-\u003cname\u003e), guest IP from state/ip.txt\n     * CPU and memory from config.sh\n   - Start firecracker in background\n   - Save PID to state/vm.pid\n   - Save socket path to state/vm.sock\n\n4. **Wait for SSH Ready**\n   - Poll SSH connection: ssh -o ConnectTimeout=2 \u003cuser\u003e@\u003cip\u003e exit\n   - Retry with exponential backoff (1s, 2s, 4s...)\n   - Timeout after 2 minutes\n   - Show progress: \"Waiting for VM to boot...\"\n\n5. **Execute First-Boot Script** (if present)\n   - Check if /first-boot.sh exists in VM: ssh \u003cvm\u003e test -f /first-boot.sh\n   - If exists:\n     * Execute via SSH: ssh \u003cvm\u003e /first-boot.sh\n     * Stream output to terminal (show progress)\n     * Wait for completion\n     * Delete script: ssh \u003cvm\u003e rm /first-boot.sh\n     * Show: \"✓ First-boot setup complete\"\n   - If doesn't exist or already run: skip (fast boot)\n\n6. **Print Ready Message**\n   - Show VM details:\n     ```\n     ✓ VM 'claude' is ready\n       IP: 172.16.0.2\n       SSH: ssh \u003cuser\u003e@172.16.0.2\n       Or: ~/vms/vm.sh ssh claude\n     ```\n\n**State After Up:**\n- state/vm.pid contains running process ID\n- state/vm.sock contains firecracker socket path\n- /first-boot.sh deleted from VM (if it was present)\n- vm list shows VM as \"running\"\n\n**Error Handling:**\n- If VM fails to start, clean up state (remove vm.pid)\n- If SSH timeout, kill VM and error\n- If first-boot.sh fails, leave VM running but show error\n- Clear error messages for all failure cases\n\n**No Sudo Required:**\n- TAP device already owned by user (created during build)\n- Firecracker runs as current user\n- All state files owned by user\n\n**Acceptance Criteria:**\n- Starts VM successfully without sudo\n- Waits for SSH before declaring ready\n- Executes first-boot.sh if present\n- Fast boot on subsequent starts (no first-boot)\n- Shows clear progress and ready message\n- Handles errors gracefully with cleanup\n- VM accessible via SSH after up completes","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:46:36.585629566+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:56.46643194+05:30","closed_at":"2026-02-05T19:08:56.466435586+05:30","dependencies":[{"issue_id":"dev-aq9.8","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:46:36.587407245+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-aq9.8","depends_on_id":"dev-aq9.3","type":"blocks","created_at":"2026-02-05T18:48:40.574928135+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-aq9.9","title":"VM Down Command (vm-down.sh)","description":"Implement VM down command to gracefully stop a running VM.\n\n**Command:** `~/vms/vm.sh down \u003cname\u003e` (no sudo required)\n\n**Scope:**\n\n1. **Validation**\n   - Check VM exists\n   - Check if running (validate state/vm.pid and process is alive)\n   - If not running, show message and exit successfully\n   - Load state files\n\n2. **Graceful Shutdown**\n   - SSH into VM: ssh \u003cuser\u003e@\u003cip\u003e \"sudo poweroff\"\n   - This triggers clean systemd shutdown inside VM\n   - Wait for process to exit (poll vm.pid)\n   - Timeout after 30 seconds\n\n3. **Forceful Shutdown** (if graceful fails)\n   - If VM doesn't stop after 30s, kill firecracker process\n   - Send SIGTERM first, wait 5s\n   - Send SIGKILL if still alive\n   - Show warning: \"VM did not stop gracefully, killed forcefully\"\n\n4. **Cleanup State**\n   - Remove state/vm.pid\n   - Remove state/vm.sock\n   - Leave TAP device active (persistent until destroy)\n   - Leave rootfs, home, and other files intact\n\n5. **Print Success Message**\n   - Show: \"✓ VM 'claude' stopped\"\n   - vm list should now show VM as \"stopped\"\n\n**No Sudo Required:**\n- All operations run as current user\n- SSH uses user credentials\n- Process kill uses user's own process\n\n**Error Handling:**\n- If VM already stopped, exit successfully with message\n- If SSH fails, fall back to forceful kill\n- If PID file stale (process doesn't exist), clean up gracefully\n- Clear error messages\n\n**Acceptance Criteria:**\n- Stops running VM gracefully without sudo\n- Falls back to forceful kill if needed\n- Cleans up state files correctly\n- Leaves VM in clean stopped state\n- vm list shows \"stopped\" after down\n- Can run vm up again after down","status":"closed","priority":1,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T18:47:39.800231293+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T19:08:57.00028764+05:30","closed_at":"2026-02-05T19:08:57.000291981+05:30","dependencies":[{"issue_id":"dev-aq9.9","depends_on_id":"dev-aq9","type":"parent-child","created_at":"2026-02-05T18:47:39.802437963+05:30","created_by":"Anand Chitipothu"},{"issue_id":"dev-aq9.9","depends_on_id":"dev-aq9.8","type":"blocks","created_at":"2026-02-05T18:48:40.690441277+05:30","created_by":"Anand Chitipothu"}]}
{"id":"dev-axr","title":"SSH connectivity broken after dev-e35 fix - user home directory not set in /etc/passwd","description":"## Problem\n\nSSH connectivity to VMs is broken after the dev-e35 fix that moved home directories to /dev/vdb. Users cannot SSH into VMs even though the VM boots successfully and the home volume mounts correctly.\n\n## Root Cause\n\nThe fix for dev-e35 changed `useradd -m` to `useradd -M` to prevent creating home on rootfs. However, `-M` doesn't set the home directory path in `/etc/passwd`, so SSH cannot find `authorized_keys` even when `/dev/vdb` is mounted at `/home`.\n\n## Impact\n\n- All VMs built with the broken code cannot be accessed via SSH\n- Affects Ubuntu VMs (Alpine VMs not impacted)\n- Completely breaks the primary access method to VMs\n\n## How to Reproduce\n\n1. Build a VM with the broken code (commit da7c35e)\n2. Start the VM with `bin/vm-up.sh`\n3. Try to SSH: `ssh username@vm-ip`\n4. Connection fails or can't find home directory\n\n## Expected Behavior\n\nSSH should work normally with key-based authentication using keys stored on `/dev/vdb`.\n\n## Fix\n\nChanged `useradd -M` to `useradd --no-create-home --home-dir \"/home/$USERNAME\"` to explicitly set the home directory path while still not creating files on rootfs.\n\nAlso improved to use actual UID/GID instead of hardcoding 1000:1000.\n\n## Verification\n\nNeed to add SSH connectivity tests to prevent regression.\n\n## Status\n\nFixed in commit 01a95bb","status":"closed","priority":0,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-06T06:36:38.926020381+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T06:36:55.891163436+05:30","closed_at":"2026-02-06T06:36:55.891163436+05:30","close_reason":"Fixed in commit 01a95bb. Changed useradd to set home path explicitly. Users need to rebuild VMs."}
{"id":"dev-b4c","title":"Implement production integration tests with Ubuntu","description":"Create comprehensive integration tests using actual Ubuntu VMs:\n\ntests/integration/test-full-lifecycle.sh - Complete workflow test\ntests/integration/test-multiple-vms.sh - Multi-VM coordination\n\nAlso create tests/run-all-tests.sh that runs unit → fast → production tests.\n\nTarget: Complete suite in \u003c5 minutes\n\nAcceptance Criteria:\n- [ ] Full lifecycle test validates init → build → up → ssh → down → destroy\n- [ ] Multi-VM test creates and coordinates 3 VMs\n- [ ] run-all-tests.sh runs complete test suite\n- [ ] Color-coded output with summary report\n- [ ] Total runtime under 5 minutes\n- [ ] Tests validate production deployment scenarios","status":"closed","priority":2,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-06T00:14:34.621800443+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T00:42:48.694942909+05:30","closed_at":"2026-02-06T00:42:48.694942909+05:30","close_reason":"Closed","labels":["firecracker-sandbox","testing"]}
{"id":"dev-bck","title":"Agent preferences for this project","description":"Modular over monolithic; no bloat (meaningful tests only); one unified test over many small test files; base image vanilla, config separate (configure-ubuntu-rootfs.sh); mandatory args with --help, logical order (e.g. version then path); base images cacheable/reusable.","status":"closed","priority":4,"issue_type":"task","owner":"anandology@gmail.com","created_at":"2026-02-06T11:08:14.797719291+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T11:08:14.870235684+05:30","closed_at":"2026-02-06T11:08:14.870235684+05:30","close_reason":"note","labels":["context","note"]}
{"id":"dev-bk6","title":"Package script should create proper vms/ directory structure and use dist/","description":"The package.sh script has several issues:\n\n1. The zip file should contain a vms/ directory so that when extracted, it creates a proper vms/ subdirectory\n2. Currently unzipping directly in home directory would scatter files, not create vms/ folder\n3. The package (vms.zip) should be output to dist/ directory instead of current directory\n4. dist/ directory needs to be added to .gitignore\n\nExpected behavior:\n- User can run: unzip vms.zip in their home directory\n- This creates ~/vms/ with all contents inside it\n- Package script outputs to dist/vms.zip\n- dist/ is gitignored","status":"closed","priority":2,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-05T20:44:39.231030906+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T21:03:34.192884196+05:30","closed_at":"2026-02-05T21:03:34.192884196+05:30","close_reason":"Closed","comments":[{"id":1,"issue_id":"dev-bk6","author":"Anand Chitipothu","text":"Additional issue found: The package.sh script currently creates dist/ in the parent directory (../dist/) but it should create it in firecracker-sandbox/ directory itself.\n\nCurrent: SCRIPT_DIR/../dist/vms.zip\nExpected: SCRIPT_DIR/dist/vms.zip (i.e., firecracker-sandbox/dist/vms.zip)\n\nAlso, note that $(cd \"$(dirname \"$0\")\" \u0026\u0026 pwd) can be replaced with the simpler realpath command which is available as a standard command:\n- Old: SCRIPT_DIR=\"$(cd \"$(dirname \"$0\")\" \u0026\u0026 pwd)\"\n- New: SCRIPT_DIR=\"$(dirname \"$(realpath \"$0\")\")\"\n\nThis makes the code cleaner and more readable.","created_at":"2026-02-05T15:31:56Z"}]}
{"id":"dev-df1","title":"Configure guest VM timezone to match host by default","description":"The guest VM should have the same timezone as the host system for consistency.\n\n**Requirements:**\n- Add `TIMEZONE` configuration option in VM config.sh\n- If `TIMEZONE` is not set, auto-detect and use the host's timezone\n- Configure timezone during VM build process (before first boot)\n- Host timezone can be detected using: `timedatectl show -p Timezone --value` or `cat /etc/timezone`\n\n**Acceptance Criteria:**\n- New VMs default to host timezone when `TIMEZONE` is unset in config.sh\n- Users can override timezone by setting `TIMEZONE` in config.sh (e.g., `TIMEZONE=\"America/New_York\"`)\n- Timezone is properly configured in the guest VM during build\n- Documentation updated to explain the timezone configuration option","status":"open","priority":3,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-05T22:14:21.09340346+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-07T09:32:50.911119061+05:30","labels":["enhancement","firecracker-sandbox"]}
{"id":"dev-e35","title":"Home directory should be on separate volume for persistence","description":"**Requirement:** User's home directory should be on /dev/vdb so the root volume (/dev/vda) can be rebuilt without losing user data and SSH keys.\n\n**Current Problem:**\n- Changed to mount /dev/vdb at /data instead of /home\n- This doesn't meet the requirement - home directory is in rootfs\n- User cannot rebuild root volume without losing home\n\n**Correct Solution:**\n1. Mount /dev/vdb to /home in fstab\n2. During vm-build.sh, create user home directory on the mounted home volume\n3. Set up SSH keys in the home volume\n4. Root volume becomes ephemeral/rebuildable\n\n**Implementation:**\n- Revert /data mount back to /home\n- Restructure vm-build.sh to set up home volume properly\n- Ensure SSH keys are in the persistent home volume\n\n**Status:** Need to implement","status":"closed","priority":3,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-05T22:57:04.456351112+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T01:17:22.045451366+05:30","closed_at":"2026-02-06T01:17:22.045451366+05:30","close_reason":"Closed","labels":["bug","firecracker-sandbox"]}
{"id":"dev-g1v","title":"test-full-lifecycle.sh fails - requires bridge setup before vm-init","description":"## Problem\n\nThe test `tests/integration/test-full-lifecycle.sh` fails at VM initialization step because it requires the Firecracker bridge to be set up first.\n\n## Root Cause\n\nThe test calls `bin/vm-init.sh` which checks for bridge existence:\n\n```bash\n# Check if bridge is set up\nBRIDGE_LINK=\"$STATE_DIR/bridge\"\nif [[ ! -L \"$BRIDGE_LINK\" ]] || [[ ! -e \"$BRIDGE_LINK\" ]]; then\n    error \"Bridge not set up. Run: sudo $BIN_DIR/setup.sh\"\nfi\n```\n\nError output:\n```\nError: Bridge not set up. Run: sudo /workspace/firecracker-sandbox/bin/setup.sh\n```\n\nThe test assumes it can run in isolation but the VM framework requires infrastructure setup (bridge) before VMs can be initialized.\n\n## How to Reproduce\n\n```bash\ncd firecracker-sandbox  \n./tests/docker/run-tests.sh \"tests/integration/test-full-lifecycle.sh\"\n```\n\nOr manually:\n```bash\ndocker run --rm --privileged --device=/dev/kvm \\\n  -v $(pwd):/workspace \\\n  -w /workspace/firecracker-sandbox \\\n  firecracker-sandbox-test \\\n  bin/vm-init.sh test-vm\n# Error: Bridge not set up\n```\n\n## Expected Behavior\n\nThe test should either:\n1. Set up required infrastructure (bridge) before testing\n2. Mock/skip the bridge check for testing\n3. Document that `setup.sh` must be run first\n\n## Fix Options\n\n**Option 1**: Add bridge setup to test\n```bash\n# In test-full-lifecycle.sh\necho \"Setting up infrastructure...\"\nsudo $BIN_DIR/setup.sh || skip_test \"Cannot set up bridge\"\n```\n\n**Option 2**: Mock the bridge check\n```bash\n# Create fake bridge link for testing\nmkdir -p $STATE_DIR\ntouch /tmp/fake-bridge\nln -s /tmp/fake-bridge $STATE_DIR/bridge\n```\n\n**Option 3**: Make vm-init.sh accept --no-bridge-check flag for testing\n\n## Dependencies\n\nThe bridge setup requires:\n- Creating `br-firecracker` bridge device\n- Configuring bridge IP (172.16.0.1/24)\n- Setting up NAT/forwarding rules\n\n## Test Command\n```bash\n./tests/docker/run-tests.sh \"tests/integration/test-full-lifecycle.sh\"\n```\n\n## Impact\n\nThis test validates the complete VM lifecycle workflow:\n- ✓ Test structure is correct\n- ✗ Cannot run without infrastructure setup\n- This is a test environment issue, not a product issue\n\n## Recommendation\n\nAdd infrastructure setup as a prerequisite check/step in the test, or document that `setup.sh` must be run before lifecycle tests.","status":"in_progress","priority":2,"issue_type":"bug","assignee":"Anand Chitipothu","owner":"anandology@gmail.com","created_at":"2026-02-06T00:56:56.596565172+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T01:13:48.972510861+05:30","labels":["bug","firecracker-sandbox","testing"],"comments":[{"id":2,"issue_id":"dev-g1v","author":"Anand Chitipothu","text":"## Investigation Summary\n\n### Root Cause\nThe `vm-init.sh` script checks for bridge existence at `$STATE_DIR/bridge` and fails if not found.\n\n### Attempted Fixes\n1. Created mock bridge link in test\n2. Fixed STATE_DIR path (was using wrong path initially)\n3. Set VMS_ROOT environment variable to redirect VM creation\n\n### Current Status\n- Bridge check now passes ✅\n- vm-init.sh reports success ✅  \n- BUT: VM directory still not created in expected location ❌\n\nThe issue is that vm-init seems to run successfully but the VM directory structure is not being created where the test expects it (`$HOME/.firecracker-vms/test-lifecycle-*`).\n\n### Remaining Issues\n- Need to verify VMS_ROOT is properly exported and used by vm-init.sh\n- May need to source config.sh before running vm-init to ensure paths are correct\n- Or may need to update test expectations to match actual VM location\n\n### Time Spent\n~15 minutes - moving to next issue per guidelines","created_at":"2026-02-05T19:45:25Z"}]}
{"id":"dev-oi2","title":"Scripts fail when run with sudo: $HOME becomes /root instead of user home","description":"setup.sh and other scripts that run with sudo have a critical issue: $HOME becomes /root instead of the actual user's home directory.\n\nRoot cause:\n- config.sh line 24 uses: VMS_ROOT=\"${VMS_ROOT:-$HOME/vms}\"\n- When run with sudo, $HOME is /root, not the user's home\n- This causes all paths to be resolved incorrectly\n\nSolution:\nAll scripts should determine the ROOT_DIRECTORY based on $0 (the script's location) instead of relying on $HOME or environment variables:\n\n- Scripts are located in $ROOT/bin/ \n- Therefore: ROOT=$(cd \"$(dirname \"$0\")/..\" \u0026\u0026 pwd)\n- From there: VMS_ROOT=$ROOT, BIN_DIR=$ROOT/bin, etc.\n\nThis makes the framework self-contained and location-independent.\n\nFiles affected:\n- config.sh (line 24)\n- vm-init.sh (line 93 - SSH key paths)\n- Any other scripts using $HOME","status":"closed","priority":1,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-05T20:47:51.706547289+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T20:49:42.195885063+05:30","closed_at":"2026-02-05T20:49:42.195885063+05:30","close_reason":"Closed"}
{"id":"dev-oy9","title":"Add vm.sh console to attach to a running VM via Unix socket","description":"Add the ability to connect to the serial console of a running VM using `vm.sh console \u003cname\u003e`. This is critical for troubleshooting when networking is broken and SSH doesn't work.\n\n## Problem\n\nCurrently `vm.sh up` starts Firecracker in the background with stdout redirected to `console.log`. There is no way to get an interactive console to a running VM.\n\nWhen networking breaks inside the guest, users are completely locked out.\n\n## Approach: socat + Unix socket\n\nUse `socat` to bridge Firecracker's stdin/stdout to a Unix domain socket. This allows `vm.sh console` to connect to the socket for an interactive serial console session.\n\n### Changes to vm.sh up (vm-up.sh)\n\nInstead of:\n```bash\n\"$FIRECRACKER_BIN\" --api-sock \"$FC_SOCKET\" --config-file \"$FC_CONFIG\" \u003e \"$STATE_DIR_VM/console.log\" 2\u003e\u00261 \u0026\n```\n\nUse socat to expose the console on a Unix socket:\n```bash\nCONSOLE_SOCK=\"$STATE_DIR_VM/console.sock\"\nrm -f \"$CONSOLE_SOCK\"\nsocat UNIX-LISTEN:$CONSOLE_SOCK,fork EXEC:\"$FIRECRACKER_BIN --api-sock $FC_SOCKET --config-file $FC_CONFIG\",pty,raw,echo=0 \u0026\n```\n\nAlso tee or capture console output to `console.log` so existing log functionality is preserved.\n\n### vm.sh console (vm-console.sh) — connect only\n\n`vm.sh console \u003cname\u003e` connects to a running VM's console socket. It does NOT start VMs.\n\n- **VM is running** → attach to the console socket: `socat -,raw,echo=0 UNIX-CONNECT:$CONSOLE_SOCK`\n- **VM is not running** → error: \"VM '\u003cname\u003e' is not running. Start it with: vm.sh up \u003cname\u003e\"\n\n### Console socket lifecycle\n- Created by `vm.sh up` at `vms/\u003cname\u003e/state/console.sock`\n- Cleaned up by `vm.sh down` (add to cleanup)\n- Multiple connections should be possible (socat `fork` option)\n\n## Implementation Notes\n\n- `socat` becomes a dependency — check for it in `vm-up.sh` and give a clear error if missing\n- Add `console.sock` path to the state files managed per-VM\n- Terminal must be put into raw mode when connecting (`-,raw,echo=0`) and restored on disconnect\n- Add trap to restore terminal settings on Ctrl-C / disconnect\n- Test edge cases: what happens if socat dies, can we reconnect, does console.log still work\n- Disconnect hint: print \"Use Ctrl-A then X to exit console, or Ctrl-C to disconnect\" before connecting\n\n## Acceptance Criteria\n\n- [ ] `vm.sh up \u003cname\u003e` starts Firecracker with console accessible via Unix socket at `state/console.sock`\n- [ ] `vm.sh console \u003cname\u003e` connects to a running VM's console interactively\n- [ ] `vm.sh console \u003cname\u003e` on a stopped VM gives an error with instructions to start it first\n- [ ] Console log (`state/console.log`) still captures output\n- [ ] `vm.sh down \u003cname\u003e` cleans up the console socket\n- [ ] Clear error if `socat` is not installed\n- [ ] Terminal is properly restored after disconnecting from console\n- [ ] Disconnect instructions printed before connecting","status":"open","priority":2,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-07T10:30:24.00658738+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-07T10:32:21.369439525+05:30"}
{"id":"dev-u87","title":"VM networking fails - eth0 interface not detected","description":"When starting a VM, the network interface (eth0) is not detected by the guest OS, making SSH connection fail with 'No route to host'.\n\n**Root Cause:**\n1. Kernel (vmlinux-6.1.77) doesn't have CONFIG_IP_PNP enabled\n2. Boot args included `ip=172.16.0.3::172.16.0.1:255.255.255.0::eth0:off` which kernel reports as \"Unknown kernel command line parameters\"\n3. Kernel cannot autoconfigure network from boot args\n4. systemd-networkd should handle network config but needs proper fstab and boot args\n\n**Solution:**\n- Remove unsupported ip= boot args from vm-up.sh\n- Add explicit root=/dev/vda rw to boot args\n- Add fstab configuration to vm-build.sh\n- Let systemd-networkd handle all network setup\n\n**Status:** Fixed in commits efd04de and ee6f8b6","status":"closed","priority":0,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-05T22:55:48.89771459+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T22:55:57.029185924+05:30","closed_at":"2026-02-05T22:55:57.029185924+05:30","close_reason":"Closed","labels":["firecracker-sandbox","networking"]}
{"id":"dev-ue4","title":"Kernel download fails - invalid S3 URL for vmlinux-6.1.102","description":"When building a VM, the kernel download fails because the S3 URL returns NoSuchKey error.\n\n**Current Configuration:**\n- Firecracker version: v1.7.0\n- Kernel version: 6.1.102\n- URL: https://s3.amazonaws.com/spec.ccfc.min/firecracker-ci/v1.7/6.1.102/x86_64/vmlinux-6.1.102\n\n**Error:**\n```xml\n\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e\n\u003cError\u003e\u003cCode\u003eNoSuchKey\u003c/Code\u003e\u003cMessage\u003eThe specified key does not exist.\u003c/Message\u003e\u003c/Error\u003e\n```\n\n**Root Cause:**\nThe kernel version 6.1.102 doesn't exist at the specified S3 path for Firecracker v1.7.\n\n**Solution:**\nNeed to find and use a valid kernel version available for Firecracker v1.7.0.\n\n**Files to update:**\n- `firecracker-sandbox/bin/config.sh` - Update KERNEL_VERSION and KERNEL_URL","notes":"## Solution Found\n\nThe kernel should use the Firecracker quickstart guide kernel which is maintained and available:\n\n**Working Kernel:**\n- URL: https://s3.amazonaws.com/spec.ccfc.min/img/quickstart_guide/x86_64/kernels/vmlinux.bin\n- This is the official kernel referenced in Firecracker documentation\n- Size: ~21MB\n\n**Change:**\nUpdate `firecracker-sandbox/bin/config.sh`:\n```bash\nKERNEL_VERSION=\"vmlinux.bin\"\nKERNEL_URL=\"https://s3.amazonaws.com/spec.ccfc.min/img/quickstart_guide/x86_64/kernels/vmlinux.bin\"\n```\n\n**Note:** Users with the broken kernel file will need to delete it and let the build script re-download:\n```bash\nrm ~/vms/kernels/vmlinux-6.1.102\n```\n## Better Solution\n\nFound user's previous kernel download script at ~/firecracker-vms/scripts/download-kernel.sh which:\n- Dynamically lists available kernels from S3\n- Validates downloads (checks file size to catch XML errors)\n- Auto-selects latest available kernel\n\n**Available kernels for Firecracker v1.7:**\n- 6.1.77 (latest 6.x)\n- 5.10.209\n- 4.14.336\n\n**Correct Configuration:**\nUse kernel 6.1.77 which actually exists for v1.7:\n```bash\nKERNEL_VERSION=\"6.1.77\"\nKERNEL_URL=\"https://s3.amazonaws.com/spec.ccfc.min/firecracker-ci/v1.7/x86_64/vmlinux-6.1.77\"\n```\n\nThis is better than the quickstart guide kernel as it:\n- Uses the latest kernel for the Firecracker version\n- Follows the project's standard kernel naming\n- Is version-specific and predictable","status":"closed","priority":1,"issue_type":"bug","owner":"anandology@gmail.com","created_at":"2026-02-05T22:27:12.998439722+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-05T22:29:54.687302308+05:30","closed_at":"2026-02-05T22:28:50.911830532+05:30","close_reason":"Closed","labels":["bug","firecracker-sandbox"]}
{"id":"dev-xje","title":"Alpine test VMs cannot ping host - missing guest network configuration","description":"## Problem\n\nTests `test-host-to-guest.sh` and `test-multiple-vms.sh` fail network connectivity checks. VMs boot successfully but cannot be pinged from host.\n\n## Root Cause\n\nThe Alpine test rootfs (`build-alpine-rootfs.sh`) creates a static network configuration in `/etc/network/interfaces`, but Alpine Linux in Firecracker VMs requires the network to be configured differently or needs additional setup.\n\nThe guest VM likely needs:\n1. Proper virtio network driver loading\n2. Network interface brought up inside the guest\n3. IP address configured on the guest interface\n\nCurrently the Alpine image has network config but it may not activate on boot, or the kernel may not have virtio-net drivers.\n\n## How to Reproduce\n\n```bash\ncd firecracker-sandbox\n./tests/docker/run-tests.sh \"bin/vm-build/build-alpine-rootfs.sh \u0026\u0026 tests/integration/test-multiple-vms.sh\"\n```\n\nOutput shows:\n```\n✓ PASS: VM 1 (test-multi-vm1-254) is running (PID: 296)\n✗ FAIL: Host cannot ping VM 1 (172.16.0.11)\n  Note: Alpine VMs may need network configuration inside guest\n```\n\n## Investigation Needed\n\n1. **Check if virtio-net is loaded**: Does the Alpine kernel have virtio-net driver compiled in?\n2. **Check guest network state**: Boot VM with console access and check `ip link` and `ip addr`\n3. **Check ifupdown**: Does Alpine's networking service start on boot?\n\n## Debug Commands\n\n```bash\n# Boot Alpine VM with console access to see what's happening\nfirecracker --api-sock /tmp/fc.sock --config-file config.json\n\n# Check Alpine kernel config\nzcat /proc/config.gz | grep VIRTIO_NET\n\n# Check network interfaces inside guest\nip link show\nip addr show\ncat /etc/network/interfaces\n```\n\n## Expected Behavior\n\nAlpine VMs should have working network connectivity:\n- eth0 interface should be visible in guest\n- IP address should be configured automatically\n- Host should be able to ping guest IP\n\n## Fix Options\n\n1. **Update Alpine builder** to ensure network comes up on boot\n2. **Add init script** to configure network in guest\n3. **Use different init system** or ensure OpenRC networking service is enabled\n4. **Add kernel modules** if virtio-net is not built-in\n\n## Test Command\n```bash\n./tests/docker/run-tests.sh \"bin/vm-build/build-alpine-rootfs.sh \u0026\u0026 tests/integration/test-host-to-guest.sh\"\n```\n\n## Related Issues\n\nThis affects:\n- `tests/integration/test-host-to-guest.sh`\n- `tests/integration/test-multiple-vms.sh` (Phase 3: Network Connectivity)\n\n## Workaround\n\nTests can still validate:\n- ✓ VM creation and management\n- ✓ Multiple VM coordination  \n- ✓ Resource isolation (IPs, TAPs, PIDs)\n- ✗ Network connectivity (known issue)\n\n## Priority\n\nP1 because this blocks validation of actual network functionality, which is core to the VM framework.","status":"in_progress","priority":1,"issue_type":"bug","assignee":"Anand Chitipothu","owner":"anandology@gmail.com","created_at":"2026-02-06T00:56:27.932650565+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T01:03:44.570705134+05:30","labels":["alpine","firecracker-sandbox","networking","testing"],"comments":[{"id":3,"issue_id":"dev-xje","author":"Anand Chitipothu","text":"## Investigation Summary\n\n### Root Cause Identified\nThe kernel (vmlinux-6.1.77) does NOT have CONFIG_IP_PNP compiled in, so the `ip=` boot parameter is completely ignored. This means network configuration must happen from userspace via Alpine's init system.\n\n### Fixes Implemented\n1. Updated `build-alpine-rootfs.sh` to enable networking service in boot runlevel (not just default)\n2. Configured static network: 172.16.0.2/24 with gateway 172.16.0.1\n3. Added local.d script to verify network comes up\n\n### Test Results\n**DEBUG TEST (test-network-debug.sh)**: ✅ SUCCESS\n- VM boots fully with OpenRC\n- Console shows: `* Starting networking ... * eth0 ... [ ok ]`\n- Ping from host to guest (172.16.0.2) succeeds with 0% packet loss\n- RTT: ~0.3-0.4ms\n\n**REGULAR TEST (test-host-to-guest.sh)**: ❌ STILL FAILING\n- Same configuration, but ping fails\n- Need to investigate why the two tests behave differently\n- Possibly timing issue or firecracker process lifecycle difference\n\n### Next Steps\n- Compare how test-network-debug.sh vs test-host-to-guest.sh start Firecracker\n- The debug test uses `timeout 15 firecracker ...` while regular test uses background process\n- May need to adjust how the test waits for network initialization\n- Consider making network initialization more reliable/deterministic\n\n### Files Modified\n- `bin/vm-build/build-alpine-rootfs.sh` - Network configuration fixes\n- `tests/integration/test-host-to-guest.sh` - Increased boot wait time to 12s\n- `tests/integration/test-network-debug.sh` - New diagnostic test (WORKS!)","created_at":"2026-02-05T19:41:49Z"}]}
{"id":"dev-xr3","title":"Replace bridge networking with direct TAP-per-VM approach","description":"Replace the current bridge-based networking (br-firecracker) with a simpler direct TAP device per VM, based on the working implementation in ~/firecracker-vms/scripts/.\n\n## Current approach (bridge)\n- Global setup.sh creates br-firecracker bridge at 172.16.0.1/24\n- Each VM gets a TAP device attached to the bridge\n- All VMs share the same subnet (172.16.0.0/24)\n- Inter-VM communication possible but networking is fragile\n\n## New approach (direct TAP per VM)\n- No bridge. Each VM gets its own TAP device with a point-to-point link to the host.\n- Each VM gets its own /24 subnet: tap-vm1: 172.16.0.1 \u003c-\u003e vm1: 172.16.0.2, tap-vm2: 172.16.1.1 \u003c-\u003e vm2: 172.16.1.2, etc.\n- Host assigns an IP directly on each TAP device.\n- NAT/MASQUERADE + FORWARD rules per TAP device for internet access.\n- Systemd service per TAP for persistence across reboots.\n- Inter-VM communication is NOT supported (acceptable tradeoff).\n\n## Reference implementation\n~/firecracker-vms/scripts/setup-tap.sh — working single-VM TAP setup with NAT and systemd persistence.\n\n## Changes needed\n- Rewrite bin/setup.sh: remove bridge creation, just enable IP forwarding and set up NAT on host interface\n- Rewrite vm-build.sh TAP setup: create tap-\u003cname\u003e with its own subnet IP (e.g. 172.16.N.1/24), no bridge attachment\n- Update vm-init.sh: assign per-VM subnet (172.16.0.0/24, 172.16.1.0/24, etc.) instead of per-VM IP on shared subnet\n- Update rootfs network config: guest uses 172.16.N.2/24 with gateway 172.16.N.1\n- Rewrite bin/cleanup.sh: remove bridge teardown, clean up per-VM TAP devices and NAT rules\n- Update vm-destroy.sh: remove TAP + its specific NAT/FORWARD rules\n- Add per-TAP systemd service for persistence (or one service managing all TAPs)\n- Update tests to reflect new networking model\n- Update CLAUDE.md/AGENTS.md networking section","status":"closed","priority":2,"issue_type":"feature","owner":"anandology@gmail.com","created_at":"2026-02-07T09:38:12.267816789+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-07T10:00:37.862926925+05:30","closed_at":"2026-02-07T10:00:37.862926925+05:30","close_reason":"Implemented direct TAP-per-VM networking, all unit tests pass"}
{"id":"dev-za9","title":"Firecracker 1.5 required for kernel 6.1","description":"Older firecracker versions crash with newer kernels.","status":"tombstone","priority":4,"issue_type":"task","owner":"anandology@gmail.com","created_at":"2026-02-06T10:49:18.671229407+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T10:49:26.358270042+05:30","close_reason":"note","labels":["api-compat","note"],"deleted_at":"2026-02-06T10:49:26.358270042+05:30","deleted_by":"daemon","delete_reason":"delete","original_type":"task"}
{"id":"dev-zeq","title":"bash arithmetic ((var++)) with set -e","description":"When using set -e, ((_VAR++)) when _VAR is 0 evaluates to 0 (falsy) and triggers immediate exit. Use _VAR=$((_VAR + 1)) instead of ((_VAR++)) in scripts that use set -e.","status":"closed","priority":4,"issue_type":"task","owner":"anandology@gmail.com","created_at":"2026-02-06T11:08:13.545080943+05:30","created_by":"Anand Chitipothu","updated_at":"2026-02-06T11:08:13.600820806+05:30","closed_at":"2026-02-06T11:08:13.600820806+05:30","close_reason":"note","labels":["note","til"]}
